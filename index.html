<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>السوق المفتوح | مینی‌اپ رسمی</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #1e293b;
            padding-bottom: 100px;
        }

        /* هدر ساده */
        .header {
            background: white;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            font-weight: 900;
            font-size: 1.2rem;
            color: #1e3a8a;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* کاروسال ویژه (افقی) */
        .special-section {
            padding: 16px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .special-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 8px;
        }

        .special-scroll::-webkit-scrollbar {
            display: none;
        }

        .special-card {
            min-width: 240px;
            background: white;
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .special-badge {
            background: #fbbf24;
            color: #1e293b;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 8px;
        }

        .special-card h3 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .special-price {
            font-weight: 700;
            color: #2563eb;
        }

        /* جستجو */
        .search-box {
            margin: 8px 16px 16px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 14px 40px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        .search-box i {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .search-icon {
            right: 16px;
        }

        .search-clear {
            left: 16px;
            cursor: pointer;
            display: none;
        }

        /* دسته‌بندی‌ها */
        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 0 16px 16px;
            scrollbar-width: none;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .cat-chip {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 18px;
            white-space: nowrap;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .cat-chip.active {
            background: #1e3a8a;
            color: white;
            border-color: #1e3a8a;
        }

        /* گرید آگهی‌ها */
        .ads-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 0 16px 16px;
        }

        .ad-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: 0.2s;
        }

        .ad-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .ad-image {
            width: 100%;
            height: 120px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 2rem;
        }

        .ad-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-info {
            padding: 12px;
        }

        .ad-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ad-price {
            font-weight: 700;
            color: #2563eb;
            font-size: 0.9rem;
        }

        .ad-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 8px;
        }

        /* دکمه شناور دستیار هوش مصنوعی */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            cursor: pointer;
            z-index: 20;
            transition: 0.2s;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        /* نوار پایین با دکمه‌های اصلی */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-around;
            padding: 8px 12px 12px;
            z-index: 15;
        }

        .bottom-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #64748b;
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
            flex: 1;
        }

        .bottom-btn.active {
            color: #2563eb;
        }

        .bottom-btn i {
            font-size: 1.3rem;
        }

        .bottom-btn span {
            font-weight: 500;
        }

        /* مودال جزئیات آگهی */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            z-index: 30;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            max-width: 400px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .modal-image {
            width: 100%;
            height: 200px;
            background: #e2e8f0;
            border-radius: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 2rem;
        }

        .modal-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }

        .modal-price {
            font-size: 1.3rem;
            font-weight: 900;
            color: #2563eb;
            margin: 12px 0;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: #f1f5f9;
            font-weight: 700;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #2563eb;
            color: white;
        }

        .loader {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
    </style>
</head>
<body>

    <!-- هدر -->
    <div class="header">
        <div class="logo">السوق المفتوح</div>
        <div class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon" id="themeIcon"></i>
        </div>
    </div>

    <!-- کاروسال ویژه -->
    <div class="special-section">
        <div class="section-title">
            <i class="fas fa-crown" style="color: #fbbf24;"></i>
            <span>آگهی‌های ویژه</span>
        </div>
        <div class="special-scroll" id="specialTrack"></div>
    </div>

    <!-- جستجو -->
    <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" placeholder="جستجو در آگهی‌ها..." oninput="searchAds()">
        <i class="fas fa-times search-clear" id="searchClear" onclick="clearSearch()"></i>
    </div>

    <!-- دسته‌بندی‌ها -->
    <div class="categories" id="categories">
        <div class="cat-chip active" onclick="filterCategory('all', this)">همه</div>
        <div class="cat-chip" onclick="filterCategory('خودرو', this)">خودرو</div>
        <div class="cat-chip" onclick="filterCategory('املاک', this)">املاک</div>
        <div class="cat-chip" onclick="filterCategory('موبایل', this)">موبایل</div>
        <div class="cat-chip" onclick="filterCategory('لپ‌تاپ', this)">لپ‌تاپ</div>
        <div class="cat-chip" onclick="filterCategory('خدمات', this)">خدمات</div>
        <div class="cat-chip" onclick="filterCategory('سایر', this)">سایر</div>
    </div>

    <!-- گرید آگهی‌ها -->
    <div id="adsContainer" class="ads-grid"></div>

    <!-- دکمه شناور دستیار هوش مصنوعی -->
    <div class="fab" onclick="openAIAssistant()">
        <i class="fas fa-robot"></i>
    </div>

    <!-- نوار پایین با دکمه‌های اصلی -->
    <div class="bottom-bar">
        <div class="bottom-btn active" onclick="loadHome()">
            <i class="fas fa-home"></i>
            <span>خانه</span>
        </div>
        <div class="bottom-btn" onclick="openBot('free')">
            <i class="fas fa-plus-circle"></i>
            <span>ثبت رایگان</span>
        </div>
        <div class="bottom-btn" onclick="openBot('special')">
            <i class="fas fa-star"></i>
            <span>ثبت ویژه</span>
        </div>
        <div class="bottom-btn" onclick="openBot('vip')">
            <i class="fas fa-crown"></i>
            <span>اشتراک</span>
        </div>
    </div>

    <!-- مودال جزئیات آگهی -->
    <div id="adModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-close" onclick="closeModal()">
                    <i class="fas fa-arrow-right"></i>
                </div>
                <span style="font-weight: 700;">جزئیات آگهی</span>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Font Awesome (برای آیکون‌ها) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">

    <script>
        const API_BASE = 'https://souq-bot.mehdi11eidani.workers.dev';
        const BOT_USERNAME = 'AlsouqAlmaftuhiran_bot';
        const SUPPORT_USERNAME = 'Mehdi_E_admin';

        const tg = Telegram.WebApp;
        tg.expand();

        let allAds = [];
        let currentFilter = 'all';
        let currentSearch = '';

        // دریافت آگهی‌ها
        async function fetchAds() {
            try {
                const res = await fetch(`${API_BASE}/api/ads`);
                const data = await res.json();
                if (data.success) {
                    allAds = data.ads || [];
                } else {
                    allAds = [];
                }
            } catch (e) {
                console.error('خطا در دریافت آگهی‌ها', e);
                allAds = [];
            }
            renderSpecialCarousel();
            renderAds();
        }

        // کاروسال ویژه
        function renderSpecialCarousel() {
            const specialAds = allAds.filter(ad => ad.ad_type === 'special');
            const track = document.getElementById('specialTrack');
            if (specialAds.length === 0) {
                track.innerHTML = '<div style="min-width:200px; color:#94a3b8;">آگهی ویژه‌ای وجود ندارد</div>';
                return;
            }
            track.innerHTML = specialAds.map(ad => `
                <div class="special-card" onclick='showAdDetail(${JSON.stringify(ad).replace(/'/g, "&apos;")})'>
                    <div class="special-badge">✨ ویژه ${ad.plan_days || 1} روزه</div>
                    <h3>${ad.title}</h3>
                    <div class="special-price">${ad.price}</div>
                    <div style="font-size:0.7rem; color:#64748b;">${ad.city}</div>
                </div>
            `).join('');
        }

        // نمایش آگهی‌ها
        function renderAds() {
            let filtered = allAds.filter(ad => ad.status === 'approved');
            if (currentFilter !== 'all') {
                filtered = filtered.filter(ad => ad.category === currentFilter);
            }
            if (currentSearch) {
                filtered = filtered.filter(ad => 
                    ad.title?.includes(currentSearch) || 
                    ad.description?.includes(currentSearch)
                );
            }
            const container = document.getElementById('adsContainer');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loader">آگهی‌ای یافت نشد</div>';
                return;
            }
            container.innerHTML = filtered.map(ad => `
                <div class="ad-card" onclick='showAdDetail(${JSON.stringify(ad).replace(/'/g, "&apos;")})'>
                    <div class="ad-image">
                        ${getImageTag(ad)}
                    </div>
                    <div class="ad-info">
                        <div class="ad-title">${ad.title}</div>
                        <div class="ad-price">${ad.price}</div>
                        <div class="ad-meta">
                            <span>${ad.city || ''}</span>
                            <span>${new Date(ad.created_at * 1000).toLocaleDateString('fa-IR')}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // تابع کمکی برای نمایش عکس
        function getImageTag(ad) {
            try {
                const images = JSON.parse(ad.image_ids || '[]');
                if (images.length > 0) {
                    const fileId = images[0];
                    const url = `https://api.telegram.org/file/bot8587925383:AAElQXNbZ8YIDJMWwX4YyVFMCOsC2pV6H6c/${fileId}`;
                    return `<img src="${url}" onerror="this.style.display='none';this.parentElement.innerHTML='<i class=\'fas fa-image\'></i>';">`;
                }
            } catch (e) {}
            return '<i class="fas fa-image"></i>';
        }

        // نمایش جزئیات آگهی
        function showAdDetail(ad) {
            const modal = document.getElementById('adModal');
            const content = document.getElementById('modalContent');
            const imageHtml = getImageTag(ad).replace('<img', '<img style="width:100%; height:200px; object-fit:cover; border-radius:20px;"');
            content.innerHTML = `
                <div class="modal-image">${imageHtml}</div>
                <h2 style="margin-bottom:4px;">${ad.title}</h2>
                <div class="modal-price">${ad.price}</div>
                <p style="margin:12px 0; line-height:1.6;">${ad.description || ''}</p>
                <div style="background:#f8fafc; padding:12px; border-radius:16px;">
                    <p><i class="fas fa-map-marker-alt"></i> ${ad.city || ''}، ${ad.country || ''}</p>
                    <p><i class="fas fa-calendar"></i> ${new Date(ad.created_at * 1000).toLocaleDateString('fa-IR')}</p>
                    ${ad.phone ? `<p><i class="fas fa-phone"></i> ${ad.phone}</p>` : ''}
                </div>
                <div class="modal-actions">
                    <button class="modal-btn" onclick="contactSeller('${ad.user_id}')">ارتباط با فروشنده</button>
                    <button class="modal-btn primary" onclick="shareAd('${ad.id}')">اشتراک‌گذاری</button>
                </div>
            `;
            modal.style.display = 'flex';
            tg.BackButton.show();
        }

        // توابع کمکی
        function contactSeller(userId) {
            tg.openTelegramLink(`https://t.me/${userId}`);
        }

        function shareAd(adId) {
            const ad = allAds.find(a => a.id == adId);
            if (ad) {
                const text = `${ad.title}\n${ad.price}\n${API_BASE}/ad/${adId}`;
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(text)}`);
            }
        }

        function filterCategory(cat, el) {
            currentFilter = cat;
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderAds();
        }

        function searchAds() {
            currentSearch = document.getElementById('searchInput').value;
            document.getElementById('searchClear').style.display = currentSearch ? 'block' : 'none';
            renderAds();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchAds();
        }

        function loadHome() {
            document.querySelectorAll('.bottom-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderAds();
        }

        // باز کردن ربات با پارامتر
        function openBot(type) {
            let startParam = '';
            if (type === 'free') startParam = 'post_ad';
            else if (type === 'special') startParam = 'special_ad';
            else if (type === 'vip') startParam = 'vip';
            tg.openTelegramLink(`https://t.me/${BOT_USERNAME}?start=${startParam}`);
        }

        // دستیار هوش مصنوعی (اینجا می‌تواند به پشتیبانی یا یک ربات هوشمند لینک دهد)
        function openAIAssistant() {
            tg.openTelegramLink(`https://t.me/${SUPPORT_USERNAME}`);
        }

        function closeModal() {
            document.getElementById('adModal').style.display = 'none';
            tg.BackButton.hide();
        }

        // تغییر تم (ساده)
        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.style.background = document.body.style.background === 'white' ? '#f5f7fa' : 'white';
            document.getElementById('themeIcon').classList.toggle('fa-moon');
            document.getElementById('themeIcon').classList.toggle('fa-sun');
        });

        tg.BackButton.onClick(closeModal);

        // شروع
        fetchAds();
    </script>
</body>
</html>
