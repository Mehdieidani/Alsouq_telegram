<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>جدار | J-DAR · سوپر اپلیکیشن هوشمند</title>
    
    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;J-DAR&quot;,
        &quot;short_name&quot;: &quot;جدار&quot;,
        &quot;start_url&quot;: &quot;/&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#0c0f1c&quot;,
        &quot;theme_color&quot;: &quot;#daa520&quot;
    }">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --primary: #daa520;
            --primary-dark: #b8860b;
            --bg-dark: #0c0f1c;
            --card-bg: rgba(20, 25, 45, 0.7);
            --text-white: #ffffff;
            --text-gray: #aaaaaa;
            --danger: #e6123d; /* رنگ قرمز دیوار برای دکمه تماس */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            overflow-x: hidden;
            direction: rtl;
        }

        /* Particles Background */
        #particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        .container { max-width: 500px; margin: 0 auto; padding: 15px 15px 100px; }

        /* Header Style */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20, 25, 45, 0.8);
            backdrop-filter: blur(15px);
            padding: 12px 20px;
            border-radius: 50px;
            border: 1px solid rgba(218, 165, 32, 0.3);
            margin-bottom: 25px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .logo-box { display: flex; align-items: center; gap: 10px; }
        .logo-circle { width: 40px; height: 40px; background: linear-gradient(45deg, var(--primary-dark), var(--primary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 0 15px var(--primary); }
        .logo-text { font-weight: 800; font-size: 22px; color: var(--primary); letter-spacing: 1px; }

        /* Wallet Card */
        .wallet-card {
            background: var(--card-bg);
            border: 1px solid rgba(218, 165, 32, 0.2);
            border-radius: 30px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .balance-label { color: var(--text-gray); font-size: 13px; }
        .balance-value { font-size: 24px; font-weight: bold; color: var(--primary); }

        /* Action Grid */
        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px; }
        .action-btn { 
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 20px; padding: 15px 5px; text-align: center; cursor: pointer;
            transition: 0.3s;
        }
        .action-btn:hover { border-color: var(--primary); transform: translateY(-3px); }
        .action-btn i { font-size: 24px; color: var(--primary); margin-bottom: 8px; display: block; }
        .action-btn span { font-size: 11px; font-weight: 600; }

        /* Categories & Ads */
        .search-bar {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 12px 20px;
            display: flex; align-items: center; margin-bottom: 25px; border: 1px solid rgba(218,165,32,0.1);
        }
        .search-bar input { background: transparent; border: none; color: white; flex: 1; outline: none; margin-right: 10px; }

        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
        .cat-chip { background: var(--card-bg); padding: 8px 18px; border-radius: 50px; white-space: nowrap; border: 1px solid rgba(218,165,32,0.2); cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: black; font-weight: bold; }

        .ad-card {
            background: var(--card-bg); border-radius: 20px; overflow: hidden;
            display: flex; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);
            height: 130px; position: relative;
        }
        .ad-img { width: 130px; height: 100%; object-fit: cover; }
        .ad-info { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .ad-title { font-weight: bold; font-size: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ad-price { color: var(--primary); font-weight: bold; font-size: 16px; }
        .ad-meta { font-size: 11px; color: var(--text-gray); }

        /* --- MODAL (DIVAR STYLE) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 1000; display: none;
            flex-direction: column;
        }
        .modal.active { display: flex; }

        .modal-body { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        
        .modal-close-btn {
            position: absolute; top: 15px; right: 15px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center; z-index: 1010;
            border: none; cursor: pointer;
        }

        .modal-image-box { width: 100%; height: 350px; background: #1a1a1a; position: relative; }
        .modal-image-box img { width: 100%; height: 100%; object-fit: cover; }

        .modal-content-padding { padding: 20px; }
        .modal-title-main { font-size: 22px; font-weight: bold; margin-bottom: 10px; }
        .modal-sub-text { color: var(--text-gray); font-size: 14px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }

        /* Warning Box */
        .safety-box {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(218,165,32,0.2);
            border-radius: 12px; padding: 15px; display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px; cursor: pointer;
        }

        /* Data Rows */
        .info-row {
            display: flex; justify-content: space-between; padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 15px;
        }
        .info-row .label { color: var(--text-gray); }
        .info-row .value { color: var(--text-white); font-weight: 500; }

        .description-box { margin-top: 25px; line-height: 1.8; color: #ddd; font-size: 15px; }

        /* Fixed Footer Buttons */
        .modal-footer {
            padding: 15px 20px 30px; background: #111422;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .btn-main { padding: 14px; border-radius: 12px; font-weight: bold; text-align: center; text-decoration: none; font-size: 16px; border: none; cursor: pointer; }
        .btn-call { background: var(--danger); color: white; }
        .btn-chat { background: transparent; border: 1px solid var(--text-gray); color: white; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; max-width: 500px;
            left: 50%; transform: translateX(-50%);
            background: rgba(20, 25, 45, 0.9); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid rgba(218, 165, 32, 0.2); z-index: 100;
            border-radius: 30px 30px 0 0;
        }
        .nav-item { text-align: center; color: var(--text-gray); cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
        .nav-item span { font-size: 11px; }

        /* Review Section */
        .review-card { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin-top: 15px; }
        .stars { color: var(--primary); margin-bottom: 5px; }
    </style>
</head>
<body>

    <canvas id="particles"></canvas>

    <div class="container">
        <header class="app-header">
            <div class="logo-box">
                <div class="logo-circle"><i class="fas fa-bolt"></i></div>
                <div class="logo-text">J-DAR</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="action-btn" style="padding: 8px; border-radius: 50%; width: 40px; height: 40px;"><i class="fas fa-globe" style="margin:0; font-size: 18px;"></i></button>
            </div>
        </header>

        <div id="homePage" class="page active">
            <div class="wallet-card">
                <div>
                    <div class="balance-label">موجودی کیف پول</div>
                    <div class="balance-value"><span id="balanceNum">0</span> <small style="font-size: 12px;">تومان</small></div>
                </div>
                <div style="text-align: left;">
                    <div class="balance-label">امتیاز وفاداری</div>
                    <div style="font-weight: bold; color: #fff;"><i class="fas fa-star" style="color: gold;"></i> <span id="pointsNum">0</span></div>
                </div>
            </div>

            <div class="action-grid">
                <div class="action-btn" onclick="redirectToBot('post')"><i class="fas fa-plus-circle"></i><span>ثبت آگهی</span></div>
                <div class="action-btn" onclick="redirectToBot('vip')"><i class="fas fa-crown"></i><span>VIP</span></div>
                <div class="action-btn" onclick="redirectToBot('wallet')"><i class="fas fa-wallet"></i><span>شارژ</span></div>
                <div class="action-btn" onclick="redirectToBot('support')"><i class="fas fa-headset"></i><span>پشتیبانی</span></div>
            </div>

            <div class="search-bar">
                <i class="fas fa-search" style="color: var(--primary);"></i>
                <input type="text" id="searchInput" placeholder="جستجو در خدمات و کالاها...">
            </div>

            <div class="category-scroll" id="catList">
                <div class="cat-chip active" onclick="filterAds('all')">همه</div>
                <div class="cat-chip" onclick="filterAds('پزشکی')">پزشکی</div>
                <div class="cat-chip" onclick="filterAds('گردشگری')">گردشگری</div>
                <div class="cat-chip" onclick="filterAds('زیارت')">زیارت</div>
            </div>

            <h3 style="margin-bottom: 15px; font-size: 18px;">جدیدترین‌ها</h3>
            <div id="adsGrid">
                <div style="text-align: center; padding: 50px; color: var(--text-gray);">در حال بارگذاری...</div>
            </div>
        </div>

        <div id="profilePage" class="page" style="display: none;">
            <div class="wallet-card" style="flex-direction: column; align-items: flex-start; gap: 15px;">
                <h3>پروفایل کاربری</h3>
                <p id="userDisplay">نام: کاربر مهمان</p>
                <p id="userTg">آیدی: @anonymous</p>
                <button class="btn-main btn-call" style="width: 100%; border-radius: 50px;">ویرایش اطلاعات</button>
            </div>
        </div>
    </div>

    <div class="modal" id="adModal">
        <button class="modal-close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
        
        <div class="modal-body">
            <div class="modal-image-box">
                <img id="modalImg" src="" alt="">
            </div>

            <div class="modal-content-padding">
                <h1 id="modalTitle" class="modal-title-main">عنوان آگهی</h1>
                <p id="modalMeta" class="modal-sub-text">دقایقی پیش در تهران</p>

                <div class="safety-box">
                    <span><i class="fas fa-shield-alt" style="color: var(--primary); margin-left: 8px;"></i> زنگ خطرهای قبل از معامله</span>
                    <i class="fas fa-chevron-left" style="font-size: 12px; color: var(--text-gray);"></i>
                </div>

                <div class="info-row">
                    <span class="label">قیمت</span>
                    <span id="modalPrice" class="value">توافقی</span>
                </div>
                <div class="info-row">
                    <span class="label">دسته‌بندی</span>
                    <span id="modalCat" class="value">-</span>
                </div>
                <div class="info-row">
                    <span class="label">شهر</span>
                    <span id="modalCity" class="value">-</span>
                </div>

                <div class="description-box">
                    <h3 style="margin-bottom: 10px; color: #fff;">توضیحات</h3>
                    <p id="modalDesc">توضیحاتی برای این آگهی ثبت نشده است.</p>
                </div>

                <div id="reviewsContainer" style="margin-top: 30px;">
                    </div>
            </div>
        </div>

        <div class="modal-footer">
            <a id="modalCallBtn" href="#" class="btn-main btn-call">اطلاعات تماس</a>
            <button class="btn-main btn-chat" onclick="alert('سرویس چت به زودی فعال می‌شود')">چت</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home')"><i class="fas fa-home"></i><span>ویترین</span></div>
        <div class="nav-item" onclick="showPage('home')"><i class="fas fa-heart"></i><span>پسندیده</span></div>
        <div class="nav-item" onclick="redirectToBot('post')"><i class="fas fa-plus-circle" style="color: var(--primary); font-size: 28px;"></i><span>ثبت آگهی</span></div>
        <div class="nav-item" onclick="showPage('profile')"><i class="fas fa-user"></i><span>جدار من</span></div>
    </nav>

    <script>
        const API_BASE = 'https://souq-bot.mehdi11eidani.workers.dev';
        const tg = window.Telegram?.WebApp;
        let allAds = [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (tg) {
                tg.expand();
                loadUserProfile();
            }
            loadAds();
            initParticles();
        });

        // --- Data Fetching ---
        async function loadAds() {
            try {
                const res = await fetch(`${API_BASE}/api/ads`);
                const data = await res.json();
                if (data.success) {
                    allAds = data.ads;
                    renderAds(allAds);
                }
            } catch (err) {
                console.error("Error loading ads", err);
            }
        }

        async function loadUserProfile() {
            const userId = tg.initDataUnsafe?.user?.id;
            if (!userId) return;
            try {
                const res = await fetch(`${API_BASE}/api/user/profile?user_id=${userId}`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('balanceNum').innerText = data.balance.toLocaleString();
                    document.getElementById('pointsNum').innerText = data.points;
                    document.getElementById('userDisplay').innerText = `نام: ${data.display_name || 'کاربر جدار'}`;
                }
            } catch (err) {}
        }

        // --- Rendering ---
        function renderAds(ads) {
            const grid = document.getElementById('adsGrid');
            if (ads.length === 0) {
                grid.innerHTML = '<div style="text-align:center; color:#aaa;">آگهی یافت نشد.</div>';
                return;
            }
            grid.innerHTML = ads.map(ad => {
                const images = JSON.parse(ad.image_ids || '[]');
                const imgUrl = images.length ? `${API_BASE}/image/${images[0]}` : 'https://via.placeholder.com/150';
                return `
                    <div class="ad-card" onclick="showAd(${ad.id})">
                        <img class="ad-img" src="${imgUrl}" loading="lazy">
                        <div class="ad-info">
                            <div class="ad-title">${ad.title}</div>
                            <div>
                                <div class="ad-price">${Number(ad.price).toLocaleString()} تومان</div>
                                <div class="ad-meta">${ad.city || 'سراسر کشور'} | ${getRelativeTime(ad.created_at)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Modal Logic ---
        function showAd(id) {
            const ad = allAds.find(a => a.id === id);
            if (!ad) return;

            const images = JSON.parse(ad.image_ids || '[]');
            document.getElementById('modalImg').src = images.length ? `${API_BASE}/image/${images[0]}` : 'https://via.placeholder.com/400';
            document.getElementById('modalTitle').innerText = ad.title;
            document.getElementById('modalPrice').innerText = `${Number(ad.price).toLocaleString()} تومان`;
            document.getElementById('modalCat').innerText = ad.category || 'متفرقه';
            document.getElementById('modalCity').innerText = ad.city || 'نامشخص';
            document.getElementById('modalDesc').innerText = ad.description || 'توضیحاتی موجود نیست.';
            document.getElementById('modalMeta').innerText = `${getRelativeTime(ad.created_at)} در ${ad.city || 'ایران'}`;
            document.getElementById('modalCallBtn').href = `tel:${ad.phone}`;

            document.getElementById('adModal').classList.add('active');
            if(tg) tg.BackButton.show();
        }

        function closeModal() {
            document.getElementById('adModal').classList.remove('active');
            if(tg) tg.BackButton.hide();
        }

        if(tg) tg.onEvent('backButtonClicked', closeModal);

        // --- Utilities ---
        function getRelativeTime(timestamp) {
            const now = Math.floor(Date.now() / 1000);
            const diff = now - timestamp;
            if (diff < 3600) return 'لحظاتی پیش';
            if (diff < 86400) return `${Math.floor(diff/3600)} ساعت پیش`;
            return `${Math.floor(diff/86400)} روز پیش`;
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(pageId + 'Page').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function filterAds(cat) {
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if (cat === 'all') renderAds(allAds);
            else renderAds(allAds.filter(a => a.category?.includes(cat)));
        }

        function redirectToBot(action) {
            const botUrl = `https://t.me/AlsouqAlmaftuhiran_bot?start=${action}`;
            if (tg) tg.openTelegramLink(botUrl);
            else window.open(botUrl, '_blank');
        }

        // --- Particles Effect ---
        function initParticles() {
            const canvas = document.getElementById('particles');
            const ctx = canvas.getContext('2d');
            let w, h, pts = [];
            function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
            window.onresize = resize; resize();
            for(let i=0; i<50; i++) pts.push({x:Math.random()*w, y:Math.random()*h, vx:Math.random()-0.5, vy:Math.random()-0.5});
            function anim() {
                ctx.clearRect(0,0,w,h);
                ctx.fillStyle = "rgba(218, 165, 32, 0.2)";
                pts.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    if(p.x<0 || p.x>w) p.vx *= -1; if(p.y<0 || p.y>h) p.vy *= -1;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                });
                requestAnimationFrame(anim);
            }
            anim();
        }
    </script>
</body>
</html>
