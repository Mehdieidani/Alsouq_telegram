<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #1e293b;
            padding: 16px 16px 80px;
        }

        .header {
            background: white;
            border-radius: 30px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 900;
            color: #1e3a8a;
        }

        .lang-btn {
            background: #e2e8f0;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 40px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        .search-box i {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .search-icon { right: 16px; }
        .search-clear { left: 16px; cursor: pointer; }

        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 4px;
        }

        .cat-chip {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            padding: 8px 18px;
            white-space: nowrap;
            cursor: pointer;
        }

        .cat-chip.active {
            background: #1e3a8a;
            color: white;
        }

        .special-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .special-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .special-card {
            min-width: 200px;
            background: white;
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .special-badge {
            background: #fbbf24;
            color: #1e293b;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 8px;
        }

        .ads-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .ad-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            cursor: pointer;
        }

        .ad-image {
            width: 100%;
            height: 120px;
            background: #e2e8f0;
        }

        .ad-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-info {
            padding: 12px;
        }

        .ad-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .ad-price {
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 4px;
        }

        .translate-btn {
            background: #e2e8f0;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 8px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-around;
            padding: 12px 20px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #64748b;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .nav-item.active {
            color: #2563eb;
        }

        .nav-item i {
            font-size: 1.3rem;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-close {
            text-align: left;
            font-size: 1.5rem;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .loader {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="logo">Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­</div>
        <button class="lang-btn" id="langBtn">ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ</button>
    </div>

    <!-- SEARCH -->
    <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
        <i class="fas fa-times search-clear" id="searchClear"></i>
    </div>

    <!-- CATEGORIES -->
    <div class="categories" id="categories">
        <div class="cat-chip active" data-cat="all">Ù‡Ù…Ù‡</div>
        <div class="cat-chip" data-cat="Ø®ÙˆØ¯Ø±Ùˆ">Ø®ÙˆØ¯Ø±Ùˆ</div>
        <div class="cat-chip" data-cat="Ø§Ù…Ù„Ø§Ú©">Ø§Ù…Ù„Ø§Ú©</div>
        <div class="cat-chip" data-cat="Ù…ÙˆØ¨Ø§ÛŒÙ„">Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
        <div class="cat-chip" data-cat="Ù„Ù¾â€ŒØªØ§Ù¾">Ù„Ù¾â€ŒØªØ§Ù¾</div>
    </div>

    <!-- SPECIAL ADS -->
    <div class="special-section">
        <div class="section-title">âœ¨ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡</div>
        <div class="special-scroll" id="specialTrack"></div>
    </div>

    <!-- ADS GRID -->
    <div id="adsContainer" class="ads-grid"></div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" data-nav="home"><i class="fas fa-home"></i><span>Ø®Ø§Ù†Ù‡</span></div>
        <div class="nav-item" data-nav="add"><i class="fas fa-plus-circle"></i><span>Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</span></div>
        <div class="nav-item" data-nav="vip"><i class="fas fa-crown"></i><span>Ø§Ø´ØªØ±Ø§Ú©</span></div>
        <div class="nav-item" data-nav="support"><i class="fas fa-headset"></i><span>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</span></div>
    </div>

    <!-- MODAL -->
    <div id="adModal" class="modal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeModal()">âœ•</div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();

        const BOT_TOKEN = '8587925383:AAElQXNbZ8YIDJMWwX4YyVFMCOsC2pV6H6c';
        const BOT_USERNAME = 'AlsouqAlmaftuhiran_bot';
        const API_BASE = 'https://souq-bot.mehdi11eidani.workers.dev';

        let allAds = [];
        let currentLang = 'fa';
        let currentFilter = 'all';
        let currentSearch = '';

        // ========== FETCH ADS ==========
        async function fetchAds() {
            try {
                const res = await fetch(`${API_BASE}/api/ads`);
                const data = await res.json();
                allAds = data.ads || [];
            } catch (e) {
                console.error(e);
                allAds = [];
            }
            renderSpecialCarousel();
            renderAds();
        }

        // ========== IMAGE URL ==========
        function getImageUrl(ad) {
            try {
                const images = JSON.parse(ad.image_ids || '[]');
                if (images.length > 0) {
                    return `https://api.telegram.org/file/bot${BOT_TOKEN}/${images[0]}`;
                }
            } catch (e) {}
            return null;
        }

        // ========== RENDER SPECIAL CAROUSEL ==========
        function renderSpecialCarousel() {
            const specialAds = allAds.filter(ad => ad.ad_type === 'special');
            const track = document.getElementById('specialTrack');
            if (specialAds.length === 0) {
                track.innerHTML = '<div style="color:#94a3b8;">Ø¢Ú¯Ù‡ÛŒ ÙˆÛŒÚ˜Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                return;
            }
            track.innerHTML = specialAds.map(ad => `
                <div class="special-card" onclick='showAdDetail(${JSON.stringify(ad).replace(/'/g, "&apos;")})'>
                    <span class="special-badge">âœ¨ ÙˆÛŒÚ˜Ù‡ ${ad.plan_days || 1} Ø±ÙˆØ²Ù‡</span>
                    <h3>${ad.title}</h3>
                    <div style="font-weight:700; color:#2563eb;">${ad.price}</div>
                </div>
            `).join('');
        }

        // ========== RENDER ADS ==========
        function renderAds() {
            let filtered = allAds.filter(ad => ad.status === 'approved');
            if (currentFilter !== 'all') {
                filtered = filtered.filter(ad => ad.category === currentFilter);
            }
            if (currentSearch) {
                filtered = filtered.filter(ad => 
                    ad.title.includes(currentSearch) || 
                    ad.description?.includes(currentSearch)
                );
            }
            const container = document.getElementById('adsContainer');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loader">Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }
            container.innerHTML = filtered.map(ad => `
                <div class="ad-card" onclick='showAdDetail(${JSON.stringify(ad).replace(/'/g, "&apos;")})'>
                    <div class="ad-image">
                        ${getImageUrl(ad) ? `<img src="${getImageUrl(ad)}">` : '<i class="fas fa-image" style="display:flex; align-items:center; justify-content:center; height:100%; color:#94a3b8;"></i>'}
                    </div>
                    <div class="ad-info">
                        <div class="ad-title">${ad.title}</div>
                        <div class="ad-price">${ad.price}</div>
                        <button class="translate-btn" onclick="event.stopPropagation(); translateAd(${ad.id})">ØªØ±Ø¬Ù…Ù‡</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== TRANSLATE WITH GOOGLE (FREE) ==========
        async function translateAd(adId) {
            const ad = allAds.find(a => a.id == adId);
            if (!ad) return;
            
            const text = ad.title + '\n' + (ad.description || '');
            const targetLang = currentLang === 'fa' ? 'en' : (currentLang === 'ar' ? 'en' : 'fa');
            
            try {
                // Google Translate API (ØºÛŒØ±Ø±Ø³Ù…ÛŒ Ùˆ Ø±Ø§ÛŒÚ¯Ø§Ù†)
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                
                let translated = '';
                data[0].forEach(item => {
                    if (item[0]) translated += item[0];
                });
                
                tg.showPopup({ 
                    title: 'ØªØ±Ø¬Ù…Ù‡',
                    message: translated || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø¬Ù…Ù‡'
                });
            } catch (e) {
                tg.showPopup({ message: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆÛŒØ³ ØªØ±Ø¬Ù…Ù‡' });
            }
        }

        // ========== SHOW AD DETAIL ==========
        function showAdDetail(ad) {
            const modal = document.getElementById('adModal');
            const content = document.getElementById('modalContent');
            const img = getImageUrl(ad) ? `<img src="${getImageUrl(ad)}" style="width:100%; height:200px; object-fit:cover; border-radius:20px; margin-bottom:16px;">` : '';
            content.innerHTML = `
                ${img}
                <h2 style="margin-bottom:8px;">${ad.title}</h2>
                <div style="color:#2563eb; font-size:1.3rem; font-weight:700; margin-bottom:12px;">${ad.price}</div>
                <p style="margin-bottom:16px;">${ad.description || ''}</p>
                <div style="background:#f8fafc; padding:16px; border-radius:20px; margin-bottom:16px;">
                    <p><i class="fas fa-map-marker-alt"></i> ${ad.city || ''} ${ad.country || ''}</p>
                    <p><i class="fas fa-calendar"></i> ${new Date(ad.created_at * 1000).toLocaleDateString('fa-IR')}</p>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="translate-btn" style="flex:1;" onclick="translateAd(${ad.id})">ØªØ±Ø¬Ù…Ù‡</button>
                    <button class="translate-btn" style="flex:1; background:#2563eb; color:white;" onclick="contactSeller('${ad.user_id}')">ØªÙ…Ø§Ø³</button>
                </div>
            `;
            modal.style.display = 'flex';
            tg.BackButton.show();
        }

        function contactSeller(userId) {
            tg.openTelegramLink(`https://t.me/${userId}`);
        }

        function closeModal() {
            document.getElementById('adModal').style.display = 'none';
            tg.BackButton.hide();
        }

        // ========== LANGUAGE SWITCH ==========
        document.getElementById('langBtn').addEventListener('click', () => {
            const langs = ['ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ', 'ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'ğŸ‡¬ğŸ‡§ English'];
            const codes = ['fa', 'ar', 'en'];
            const currentIndex = codes.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % 3;
            currentLang = codes[nextIndex];
            document.getElementById('langBtn').innerText = langs[nextIndex];
            document.documentElement.dir = currentLang === 'en' ? 'ltr' : 'rtl';
        });

        // ========== SEARCH ==========
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentSearch = e.target.value;
            document.getElementById('searchClear').style.display = currentSearch ? 'block' : 'none';
            renderAds();
        });

        document.getElementById('searchClear').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            document.getElementById('searchClear').style.display = 'none';
            renderAds();
        });

        // ========== CATEGORY FILTER ==========
        document.querySelectorAll('.cat-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.cat;
                renderAds();
            });
        });

        // ========== BOTTOM NAVIGATION ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                const nav = item.dataset.nav;
                if (nav === 'add') {
                    tg.openTelegramLink(`https://t.me/${BOT_USERNAME}?start=post_ad`);
                } else if (nav === 'vip') {
                    tg.openTelegramLink(`https://t.me/${BOT_USERNAME}?start=vip`);
                } else if (nav === 'support') {
                    tg.openTelegramLink(`https://t.me/Mehdi_E_admin`);
                }
            });
        });

        // ========== INIT ==========
        fetchAds();
        tg.BackButton.onClick(closeModal);
    </script>
</body>
</html>
