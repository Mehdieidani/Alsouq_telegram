<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¬Ø¯Ø§Ø± | J-DAR Â· Ø³ÙˆÙ¾Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{
        &quot;name&quot;: &quot;J-DAR&quot;,
        &quot;short_name&quot;: &quot;Ø¬Ø¯Ø§Ø±&quot;,
        &quot;start_url&quot;: &quot;/&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#0c0f1c&quot;,
        &quot;theme_color&quot;: &quot;#daa520&quot;
    }">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --primary: #daa520;
            --primary-dark: #b8860b;
            --bg-dark: #0c0f1c;
            --card-bg: rgba(20, 25, 45, 0.7);
            --text-white: #ffffff;
            --text-gray: #aaaaaa;
            --danger: #e6123d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-white);
            line-height: 1.6;
            overflow-x: hidden;
            direction: rtl;
        }

        /* Particles Background */
        #particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        .container { max-width: 500px; margin: 0 auto; padding: 15px 15px 100px; }

        /* Header Style */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20, 25, 45, 0.8);
            backdrop-filter: blur(15px);
            padding: 12px 20px;
            border-radius: 50px;
            border: 1px solid rgba(218, 165, 32, 0.3);
            margin-bottom: 25px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .logo-box { display: flex; align-items: center; gap: 10px; }
        .logo-circle { width: 40px; height: 40px; background: linear-gradient(45deg, var(--primary-dark), var(--primary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 0 15px var(--primary); }
        .logo-text { font-weight: 800; font-size: 22px; color: var(--primary); letter-spacing: 1px; }

        .header-left { display: flex; gap: 10px; align-items: center; }
        .header-left .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(218,165,32,0.2); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .header-left .icon-btn:hover { border-color: var(--primary); }

        /* Wallet Card */
        .wallet-card {
            background: var(--card-bg);
            border: 1px solid rgba(218, 165, 32, 0.2);
            border-radius: 30px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .balance-label { color: var(--text-gray); font-size: 13px; }
        .balance-value { font-size: 24px; font-weight: bold; color: var(--primary); }

        /* Action Grid */
        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px; }
        .action-btn { 
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 20px; padding: 15px 5px; text-align: center; cursor: pointer;
            transition: 0.3s;
        }
        .action-btn:hover { border-color: var(--primary); transform: translateY(-3px); }
        .action-btn i { font-size: 24px; color: var(--primary); margin-bottom: 8px; display: block; }
        .action-btn span { font-size: 11px; font-weight: 600; }

        /* Search */
        .search-bar {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 12px 20px;
            display: flex; align-items: center; margin-bottom: 25px; border: 1px solid rgba(218,165,32,0.1);
        }
        .search-bar input { background: transparent; border: none; color: white; flex: 1; outline: none; margin-right: 10px; }

        /* Categories */
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
        .cat-chip { background: var(--card-bg); padding: 8px 18px; border-radius: 50px; white-space: nowrap; border: 1px solid rgba(218,165,32,0.2); cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: black; font-weight: bold; }

        /* Ad Card - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© */
        .ad-card {
            background: var(--card-bg); border-radius: 20px; overflow: hidden;
            display: flex; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);
            height: 130px; position: relative; cursor: pointer;
            transition: all 0.3s ease;
        }
        .ad-card.special-ad {
            border: 2px solid var(--primary);
            box-shadow: 0 0 20px rgba(218,165,32,0.5);
            background: linear-gradient(145deg, rgba(20,25,45,0.9), rgba(30,35,55,0.9));
        }
        .ad-card.special-ad::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #daa520, #f5e56b, #daa520);
            border-radius: 22px;
            z-index: -1;
            animation: goldPulse 2s infinite;
        }
        @keyframes goldPulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .ad-card .favorite {
            position: absolute; top: 10px; left: 10px; width: 36px; height: 36px;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 1px solid rgba(218,165,32,0.4); z-index: 10;
        }
        .ad-card .favorite:hover { background: var(--primary); }
        .ad-img { width: 130px; height: 100%; object-fit: cover; }
        .ad-info { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .ad-title { font-weight: bold; font-size: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ad-price { color: var(--primary); font-weight: bold; font-size: 16px; }
        .ad-meta { font-size: 11px; color: var(--text-gray); }
        .special-badge {
            position: absolute; top: 10px; right: 10px; background: var(--primary); color: black;
            padding: 4px 10px; border-radius: 50px; font-size: 11px; font-weight: bold; z-index: 5;
            box-shadow: 0 0 10px gold;
        }

        /* MODAL - ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 1000; display: none;
            flex-direction: column; overflow-y: auto;
        }
        .modal.active { display: flex; }

        .modal-close-btn {
            position: absolute; top: 15px; right: 15px; width: 40px; height: 40px;
            background: rgba(0,0,0,0.5); border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center; z-index: 1010;
            border: none; cursor: pointer;
        }

        .modal-image-container {
            width: 100%;
            height: 350px;
            background: #1a1a1a;
            position: relative;
            overflow: hidden;
        }
        .modal-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        .more-images-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            border: 1px solid var(--primary);
            backdrop-filter: blur(5px);
            cursor: pointer;
            z-index: 10;
        }
        .more-images-btn i {
            margin-left: 5px;
        }
        .modal-watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(218,165,32,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            backdrop-filter: blur(4px);
            z-index: 10;
        }

        .modal-content-padding { padding: 20px; }
        .modal-title-main { font-size: 22px; font-weight: bold; margin-bottom: 10px; }
        .modal-sub-text { color: var(--text-gray); font-size: 14px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }

        .info-row {
            display: flex; justify-content: space-between; padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 15px;
        }
        .info-row .label { color: var(--text-gray); }
        .info-row .value { color: var(--text-white); font-weight: 500; }

        .description-box { margin-top: 25px; line-height: 1.8; color: #ddd; font-size: 15px; }

        /* Review Section */
        .review-section { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; }
        .review-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .review-header .avg { font-size: 24px; font-weight: bold; color: var(--primary); }
        .review-header .stars { color: var(--primary); font-size: 18px; }
        .review-header .count { color: var(--text-gray); }
        .review-item {
            background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin-bottom: 15px;
        }
        .review-item .user { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .review-item .user i { background: var(--primary); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .review-item .rating-stars { color: var(--primary); margin-bottom: 5px; }
        .review-item .comment { color: #ddd; margin-bottom: 5px; }
        .review-item .date { font-size: 11px; color: var(--text-gray); }
        .review-input { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .review-input input, .review-input textarea {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(218,165,32,0.2);
            border-radius: 12px; padding: 12px 15px; color: white; resize: none;
        }
        .review-input button {
            background: var(--primary); border: none; border-radius: 12px; padding: 12px;
            color: black; font-weight: bold; cursor: pointer;
        }

        /* Fixed Footer Buttons */
        .modal-footer {
            padding: 15px 20px 30px; background: #111422;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        }
        .btn-main { padding: 14px; border-radius: 12px; font-weight: bold; text-align: center; text-decoration: none; font-size: 16px; border: none; cursor: pointer; }
        .btn-call { background: var(--danger); color: white; }
        .btn-wa { background: #25D366; color: white; }
        .btn-telegram { background: #0088cc; color: white; }
        .btn-disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Profile Page */
        .page { display: none; }
        .page.active { display: block; }

        .profile-section {
            background: var(--card-bg); border-radius: 30px; padding: 20px;
            border: 1px solid rgba(218,165,32,0.2);
        }
        .profile-field { margin-bottom: 20px; }
        .profile-field label { display: block; color: var(--primary); margin-bottom: 5px; font-size: 14px; }
        .profile-field input, .profile-field select {
            width: 100%; padding: 12px 15px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(218,165,32,0.2); border-radius: 15px; color: white;
        }
        .copy-link-row { display: flex; gap: 8px; }
        .copy-link-row input { flex: 1; }
        .share-btn {
            width: 45px; height: 45px; border-radius: 15px; background: rgba(218,165,32,0.2);
            border: 1px solid var(--primary); display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .save-profile {
            background: var(--primary); border: none; border-radius: 30px; padding: 14px;
            width: 100%; color: black; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; max-width: 500px;
            left: 50%; transform: translateX(-50%);
            background: rgba(20, 25, 45, 0.9); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid rgba(218, 165, 32, 0.2); z-index: 100;
            border-radius: 30px 30px 0 0;
        }
        .nav-item { text-align: center; color: var(--text-gray); cursor: pointer; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
        .nav-item span { font-size: 11px; }

        /* Gallery Modal (fullscreen) */
        .gallery-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .gallery-modal.active { display: flex; }
        .gallery-content { max-width: 500px; width: 100%; position: relative; }
        .gallery-back {
            position: absolute; top: -50px; left: 20px; width: 40px; height: 40px;
            background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; cursor: pointer;
        }
        .gallery-image { width: 100%; border-radius: 20px; border: 3px solid var(--primary); }
        .gallery-controls { display: flex; justify-content: space-between; margin-top: 20px; color: white; }
        .gallery-nav { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .gallery-watermark {
            position: absolute; bottom: 20px; right: 20px; background: rgba(218,165,32,0.7);
            color: white; padding: 6px 15px; border-radius: 40px; backdrop-filter: blur(4px);
        }

        .telegram-warning {
            background: #ffc107; color: #000; text-align: center; padding: 10px;
            border-radius: 50px; margin-bottom: 15px; display: none;
        }
        .telegram-warning.show { display: block; }
    </style>
</head>
<body>

    <canvas id="particles"></canvas>

    <div class="container">
        <div class="telegram-warning" id="telegramWarning">
            âš ï¸ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©ØŒ ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ø¨ÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø©
        </div>

        <!-- Ù‡Ø¯Ø± -->
        <header class="app-header">
            <div class="logo-box">
                <div class="logo-circle"><i class="fas fa-bolt"></i></div>
                <div class="logo-text">J-DAR</div>
            </div>
            <div class="header-left">
                <div class="icon-btn" id="langMainBtn"><i class="fas fa-globe"></i></div>
                <div class="icon-btn" id="supportBtn"><i class="fas fa-headset"></i></div>
            </div>
        </header>

        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ (ÙˆÛŒØªØ±ÛŒÙ†) -->
        <div id="homePage" class="page active">
            <div class="wallet-card">
                <div>
                    <div class="balance-label" data-i18n="balance">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„</div>
                    <div class="balance-value"><span id="walletBalance">0</span> <small style="font-size: 12px;">ØªÙˆÙ…Ø§Ù†</small></div>
                </div>
                <div style="text-align: left;">
                    <div class="balance-label" data-i18n="points">Ø§Ù…ØªÛŒØ§Ø² ÙˆÙØ§Ø¯Ø§Ø±ÛŒ</div>
                    <div style="font-weight: bold; color: #fff;"><i class="fas fa-star" style="color: gold;"></i> <span id="userPoints">0</span></div>
                </div>
            </div>

            <div class="action-grid">
                <div class="action-btn" id="postAdBtn"><i class="fas fa-plus-circle"></i><span data-i18n="post_ad">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</span></div>
                <div class="action-btn" id="vipBtn"><i class="fas fa-crown"></i><span data-i18n="vip_subscription">VIP</span></div>
                <div class="action-btn" id="chargeBtn"><i class="fas fa-wallet"></i><span data-i18n="charge">Ø´Ø§Ø±Ú˜</span></div>
                <div class="action-btn" id="convertPointsBtn"><i class="fas fa-gift"></i><span data-i18n="convert_points">ØªØ¨Ø¯ÛŒÙ„</span></div>
            </div>

            <div class="search-bar">
                <i class="fas fa-search" style="color: var(--primary);"></i>
                <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø®Ø¯Ù…Ø§Øª Ùˆ Ú©Ø§Ù„Ø§Ù‡Ø§...">
            </div>

            <div class="category-scroll" id="mainCategoryList">
                <!-- Ø¨Ø§ js Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>

            <h3 style="margin-bottom: 15px; font-size: 18px;" data-i18n="latest_ads">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†â€ŒÙ‡Ø§</h3>
            <div id="adsGrid"></div>
        </div>

        <!-- ØµÙØ­Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ -->
        <div id="favoritesPage" class="page">
            <h3 style="color:var(--primary); margin-bottom:20px;"><i class="fas fa-heart"></i> <span data-i18n="favorites">Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</span></h3>
            <div id="favoritesGrid"></div>
        </div>

        <!-- ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
        <div id="profilePage" class="page">
            <div class="profile-section">
                <div class="profile-field">
                    <label data-i18n="tg_username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…</label>
                    <input type="text" id="tgUsername" readonly>
                </div>
                <div class="profile-field">
                    <label data-i18n="display_name_label">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                    <input type="text" id="displayName" data-i18n-placeholder="display_name_placeholder" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
                </div>
                <div class="profile-field">
                    <label data-i18n="country_label">Ú©Ø´ÙˆØ±</label>
                    <select id="country">
                        <option value="IR">ğŸ‡®ğŸ‡· Ø§ÛŒØ±Ø§Ù†</option>
                        <option value="IQ">ğŸ‡®ğŸ‡¶ Ø¹Ø±Ø§Ù‚</option>
                    </select>
                </div>
                <div class="profile-field">
                    <label data-i18n="balance_label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„:</label> <span id="profileBalance">0</span> ØªÙˆÙ…Ø§Ù†
                </div>
                <div class="profile-field">
                    <label data-i18n="points_label">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§:</label> <span id="profilePoints">0</span>
                </div>
                <div class="profile-field">
                    <label data-i18n="referral_link_label">Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</label>
                    <div class="copy-link-row">
                        <input type="text" id="referralLink" readonly>
                        <button id="copyReferral" class="share-btn" style="width:45px;"><i class="fas fa-copy"></i></button>
                        <button id="shareReferral" class="share-btn"><i class="fas fa-share-alt"></i></button>
                    </div>
                </div>
                <button class="save-profile" id="saveProfile"><i class="fas fa-save"></i> <span data-i18n="save">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</span></button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒ (Ø¨Ø¯ÙˆÙ† ÙƒØ§Ø±ÙˆØ³Ù„ØŒ Ù…Ø¹ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØ²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯) -->
    <div class="modal" id="adModal">
        <button class="modal-close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
        
        <div class="modal-body" style="flex:1; overflow-y:auto;">
            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© -->
            <div class="modal-image-container" id="modalImageContainer">
                <img id="modalMainImage" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" onclick="openGalleryFromMain()">
                <div class="more-images-btn" id="moreImagesBtn" onclick="openGalleryFromMain()">
                    <i class="fas fa-images"></i> <span id="moreImagesText">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</span>
                </div>
                <div class="modal-watermark">J-DAR</div>
            </div>

            <div class="modal-content-padding">
                <h1 id="modalTitle" class="modal-title-main">Ø¹Ù†ÙˆØ§Ù† Ø¢Ú¯Ù‡ÛŒ</h1>
                <p id="modalMeta" class="modal-sub-text">Ø¯Ù‚Ø§ÛŒÙ‚ÛŒ Ù¾ÛŒØ´ Ø¯Ø± ØªÙ‡Ø±Ø§Ù†</p>

                <div class="info-row">
                    <span class="label">Ù‚ÛŒÙ…Øª</span>
                    <span id="modalPrice" class="value">ØªÙˆØ§ÙÙ‚ÛŒ</span>
                </div>
                <div class="info-row">
                    <span class="label">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</span>
                    <span id="modalCat" class="value">-</span>
                </div>
                <div class="info-row">
                    <span class="label">Ø´Ù‡Ø±</span>
                    <span id="modalCity" class="value">-</span>
                </div>

                <div class="description-box">
                    <h3 style="margin-bottom: 10px; color: #fff;">ØªÙˆØ¶ÛŒØ­Ø§Øª</h3>
                    <p id="modalDesc">ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                </div>

                <!-- Ø¨Ø®Ø´ Ù†Ø¸Ø±Ø§Øª -->
                <div id="reviewsContainer" class="review-section"></div>
            </div>
        </div>

        <div class="modal-footer">
            <a id="modalCallBtn" href="#" class="btn-main btn-call">ØªÙ…Ø§Ø³</a>
            <a id="modalWhatsappBtn" href="#" target="_blank" class="btn-main btn-wa">ÙˆØ§ØªØ³Ø§Ù¾</a>
            <a id="modalTelegramBtn" href="#" target="_blank" class="btn-main btn-telegram">ØªÙ„Ú¯Ø±Ø§Ù…</a>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ú¯Ø§Ù„Ø±ÛŒ ØªØµØ§ÙˆÛŒØ± (ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡) -->
    <div class="gallery-modal" id="galleryModal">
        <div class="gallery-content">
            <div class="gallery-back" id="galleryBack"><i class="fas fa-arrow-right"></i></div>
            <img id="galleryImg" class="gallery-image" src="">
            <div class="gallery-controls">
                <div class="gallery-nav" id="galleryPrev"><i class="fas fa-chevron-right"></i></div>
                <span class="gallery-counter" id="galleryCounter">1/1</span>
                <div class="gallery-nav" id="galleryNext"><i class="fas fa-chevron-left"></i></div>
            </div>
            <div class="gallery-watermark">J-DAR</div>
        </div>
    </div>

    <!-- Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-page="home"><i class="fas fa-home"></i><span data-i18n="home">ÙˆÛŒØªØ±ÛŒÙ†</span></div>
        <div class="nav-item" data-page="favorites"><i class="fas fa-heart"></i><span data-i18n="favorites">Ù¾Ø³Ù†Ø¯ÛŒØ¯Ù‡</span></div>
        <div class="nav-item" data-page="profile"><i class="fas fa-user"></i><span data-i18n="profile">Ø¬Ø¯Ø§Ø± Ù…Ù†</span></div>
    </nav>

    <script>
        // ========== PWA ==========
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

        // ========== ØªÙ„Ú¯Ø±Ø§Ù… ==========
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.expand(); tg.enableClosingConfirmation(); }
        const isTelegram = !!tg;
        const warn = document.getElementById('telegramWarning');
        if (!isTelegram) warn.classList.add('show');

        // ========== Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§ ==========
        const BOT_USERNAME = 'AlsouqAlmaftuhiran_bot';
        const API_BASE = 'https://souq-bot.mehdi11eidani.workers.dev';
        // Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø§Ù„Ø°ÙŠ Ù†Ø±ÙŠØ¯ ØªØ¹Ø·ÙŠÙ„ Ø²Ø± ØªÙ„Ø¬Ø±Ø§Ù… Ù„Ù‡
        const MY_TELEGRAM_ID = 'Mehdi_E_admin'; // Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ù‡

        let currentLang = localStorage.getItem('jedar_lang') || 'fa';
        let favorites = JSON.parse(localStorage.getItem('jedar_favorites') || '[]');
        let allAds = [];

        const tgUser = tg?.initDataUnsafe?.user;
        const userId = tgUser?.id?.toString();
        if (tgUser) document.getElementById('tgUsername').value = tgUser.username || tgUser.id;

        const countryCodes = { IR: '98', IQ: '964' };

        // ========== ØªØ±Ø¬Ù…Ù‡â€ŒÙ‡Ø§ ==========
        const translations = {
            fa: {
                home: 'ÙˆÛŒØªØ±ÛŒÙ†', favorites: 'Ù¾Ø³Ù†Ø¯ÛŒØ¯Ù‡', profile: 'Ø¬Ø¯Ø§Ø± Ù…Ù†',
                post_ad: 'Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ', vip_subscription: 'VIP', charge: 'Ø´Ø§Ø±Ú˜', convert_points: 'ØªØ¨Ø¯ÛŒÙ„',
                searchPlaceholder: 'Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø®Ø¯Ù…Ø§Øª Ùˆ Ú©Ø§Ù„Ø§Ù‡Ø§...',
                categories_title: 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§', all: 'Ù‡Ù…Ù‡', latest_ads: 'Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†â€ŒÙ‡Ø§', more: 'Ø¨ÛŒØ´ØªØ±',
                no_ads: 'Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', balance: 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„', points: 'Ø§Ù…ØªÛŒØ§Ø² ÙˆÙØ§Ø¯Ø§Ø±ÛŒ',
                call: 'ØªÙ…Ø§Ø³', chat: 'Ú†Øª', whatsapp: 'ÙˆØ§ØªØ³Ø§Ù¾', telegram: 'ØªÙ„Ú¯Ø±Ø§Ù…',
                contactInfo: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³', save: 'Ø°Ø®ÛŒØ±Ù‡',
                copyHint: 'Ú©Ù¾ÛŒ Ø´Ø¯', install: 'Ù†ØµØ¨', imageCounter: '{current} Ø§Ø² {total}', reviewsCount: 'Ù†Ø¸Ø±',
                tg_username: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…', display_name_label: 'Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ',
                display_name_placeholder: 'Ù†Ø§Ù… Ø´Ù…Ø§', country_label: 'Ú©Ø´ÙˆØ±',
                balance_label: 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„:', points_label: 'Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§:',
                referral_link_label: 'Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª', special_badge: 'Ù†Ø±Ø¯Ø¨Ø§Ù† Ø´Ø¯Ù‡',
                negotiable: 'ØªÙˆØ§ÙÙ‚ÛŒ',
                more_images: 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±',
                categories: {
                    'Ù¾Ø²Ø´Ú©ÛŒ':'Ù¾Ø²Ø´Ú©ÛŒ','Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ':'Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ','Ø²ÛŒØ§Ø±Øª':'Ø²ÛŒØ§Ø±Øª'
                }
            },
            ar: {
                home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', favorites: 'Ø§Ù„Ù…ÙØ¶Ù„Ø©', profile: 'Ø§Ù„Ù…Ù„Ù',
                post_ad: 'Ø¥Ø¹Ù„Ø§Ù†', vip_subscription: 'VIP', charge: 'Ø´Ø­Ù†', convert_points: 'ØªØ­ÙˆÙŠÙ„',
                searchPlaceholder: 'Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª...',
                categories_title: 'Ø§Ù„ÙØ¦Ø§Øª', all: 'Ø§Ù„ÙƒÙ„', latest_ads: 'Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª', more: 'Ø§Ù„Ù…Ø²ÙŠØ¯',
                no_ads: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª', balance: 'Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©', points: 'Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡',
                call: 'Ø§ØªØµØ§Ù„', chat: 'Ø¯Ø±Ø¯Ø´Ø©', whatsapp: 'ÙˆØ§ØªØ³Ø§Ø¨', telegram: 'ØªÙ„ØºØ±Ø§Ù…',
                contactInfo: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„', save: 'Ø­ÙØ¸',
                copyHint: 'ØªÙ… Ø§Ù„Ù†Ø³Ø®', install: 'ØªØ«Ø¨ÙŠØª', imageCounter: '{current} Ù…Ù† {total}', reviewsCount: 'Ø±Ø£ÙŠ',
                tg_username: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', display_name_label: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶',
                display_name_placeholder: 'Ø§Ø³Ù…Ùƒ', country_label: 'Ø§Ù„Ø¯ÙˆÙ„Ø©',
                balance_label: 'Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø©:', points_label: 'Ù†Ù‚Ø§Ø·Ùƒ:',
                referral_link_label: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©', special_badge: 'Ù…Ù…ÙŠØ²',
                negotiable: 'Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙØ§ÙˆØ¶',
                more_images: 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±',
                categories: {
                    'Ù¾Ø²Ø´Ú©ÛŒ':'Ø·Ø¨','Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ':'Ø³ÙŠØ§Ø­Ø©','Ø²ÛŒØ§Ø±Øª':'Ø²ÙŠØ§Ø±Ø©'
                }
            },
            en: {
                home: 'Home', favorites: 'Favorites', profile: 'My J-DAR',
                post_ad: 'Post Ad', vip_subscription: 'VIP', charge: 'Charge', convert_points: 'Convert',
                searchPlaceholder: 'Search services...',
                categories_title: 'Categories', all: 'All', latest_ads: 'Latest Ads', more: 'More',
                no_ads: 'No ads found', balance: 'Wallet Balance', points: 'Loyalty Points',
                call: 'Call', chat: 'Chat', whatsapp: 'WhatsApp', telegram: 'Telegram',
                contactInfo: 'Contact Info', save: 'Save',
                copyHint: 'Copied', install: 'Install', imageCounter: '{current} of {total}', reviewsCount: 'reviews',
                tg_username: 'Telegram Username', display_name_label: 'Display Name',
                display_name_placeholder: 'Your name', country_label: 'Country',
                balance_label: 'Wallet Balance:', points_label: 'Your Points:',
                referral_link_label: 'Referral Link', special_badge: 'Promoted',
                negotiable: 'Negotiable',
                more_images: 'View more images',
                categories: {
                    'Ù¾Ø²Ø´Ú©ÛŒ':'Medical','Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ':'Tourism','Ø²ÛŒØ§Ø±Øª':'Pilgrimage'
                }
            }
        };

        function t(key, catKey = null) {
            if (catKey) return translations[currentLang]?.categories?.[catKey] || catKey;
            return translations[currentLang]?.[key] || key;
        }

        function formatPrice(price) {
            if (price === undefined || price === null) return t('negotiable');
            if (typeof price === 'string') {
                const trimmed = price.replace(/\s/g, '');
                if (/^\d+$/.test(trimmed)) {
                    return Number(trimmed).toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
                } else {
                    return t('negotiable');
                }
            }
            if (typeof price === 'number') {
                return price.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            }
            return t('negotiable');
        }

        function formatPhoneNumber(phone, countryCode) {
            if (!phone) return null;
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø£ÙŠ Ø£Ø­Ø±Ù ØºÙŠØ± Ø±Ù‚Ù…ÙŠØ©
            let cleaned = phone.replace(/\D/g, '');
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨ØµÙØ±ØŒ Ù†Ø­Ø°ÙÙ‡
            if (cleaned.startsWith('0')) cleaned = cleaned.substring(1);
            // Ù†Ø¶ÙŠÙ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!cleaned.startsWith(countryCode)) {
                cleaned = countryCode + cleaned;
            }
            return cleaned;
        }

        function updateUILanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                let k = el.getAttribute('data-i18n');
                if (k && !el.closest('.logo-box')) el.textContent = t(k);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
            });
            renderCategories();
            renderAds(allAds, 'adsGrid');
            renderAds(allAds.filter(ad => favorites.includes(ad.id)), 'favoritesGrid');
        }

        document.getElementById('langMainBtn').addEventListener('click', () => {
            if (tg) {
                tg.showPopup({
                    title: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†',
                    message: 'Ø²Ø¨Ø§Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:',
                    buttons: [
                        { id: 'fa', type: 'default', text: 'ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ' },
                        { id: 'ar', type: 'default', text: 'ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
                        { id: 'en', type: 'default', text: 'ğŸ‡¬ğŸ‡§ English' }
                    ]
                }, (btnId) => {
                    if (btnId && ['fa','ar','en'].includes(btnId)) {
                        currentLang = btnId;
                        localStorage.setItem('jedar_lang', btnId);
                        document.documentElement.lang = btnId;
                        document.documentElement.dir = (btnId === 'fa' || btnId === 'ar') ? 'rtl' : 'ltr';
                        updateUILanguage();
                    }
                });
            } else {
                let newLang = prompt('Enter language (fa/ar/en):', currentLang);
                if (newLang && ['fa','ar','en'].includes(newLang)) {
                    currentLang = newLang;
                    localStorage.setItem('jedar_lang', newLang);
                    document.documentElement.lang = newLang;
                    document.documentElement.dir = (newLang === 'fa' || newLang === 'ar') ? 'rtl' : 'ltr';
                    updateUILanguage();
                }
            }
        });

        document.getElementById('supportBtn').addEventListener('click', () => {
            const url = 'https://t.me/Mehdi_E_admin';
            if (tg) tg.openTelegramLink(url); else window.open(url, '_blank');
        });

        // ========== Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ ==========
        const mainCats = ['Ù¾Ø²Ø´Ú©ÛŒ', 'Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ', 'Ø²ÛŒØ§Ø±Øª'];
        let currentMainCat = 'all';

        function renderCategories() {
            const catDiv = document.getElementById('mainCategoryList');
            let html = `<span class="cat-chip ${currentMainCat === 'all' ? 'active' : ''}" onclick="filterAds('all')">${t('all')}</span>`;
            mainCats.forEach(cat => {
                html += `<span class="cat-chip ${currentMainCat === cat ? 'active' : ''}" onclick="filterAds('${cat}')">${t('categories', cat)}</span>`;
            });
            catDiv.innerHTML = html;
        }

        window.filterAds = (cat) => {
            currentMainCat = cat;
            renderCategories();
            if (cat === 'all') renderAds(allAds, 'adsGrid');
            else renderAds(allAds.filter(ad => ad.category?.includes(cat)), 'adsGrid');
        };

        // ========== Ø²Ù…Ø§Ù† Ù†Ø³Ø¨ÛŒ ==========
        function getRelativeTime(ts) {
            const diff = Math.floor(Date.now()/1000) - ts;
            if(diff<60) return currentLang==='fa'?'Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ù¾ÛŒØ´':(currentLang==='ar'?'Ù…Ù†Ø° Ù„Ø­Ø¸Ø§Øª':'just now');
            if(diff<3600) return currentLang==='fa'?`${Math.floor(diff/60)} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´`:(currentLang==='ar'?`Ù…Ù†Ø° ${Math.floor(diff/60)} Ø¯Ù‚ÙŠÙ‚Ø©`:`${Math.floor(diff/60)} minutes ago`);
            if(diff<86400) return currentLang==='fa'?`${Math.floor(diff/3600)} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´`:(currentLang==='ar'?`Ù…Ù†Ø° ${Math.floor(diff/3600)} Ø³Ø§Ø¹Ø©`:`${Math.floor(diff/3600)} hours ago`);
            if(diff<604800) return currentLang==='fa'?`${Math.floor(diff/86400)} Ø±ÙˆØ² Ù¾ÛŒØ´`:(currentLang==='ar'?`Ù…Ù†Ø° ${Math.floor(diff/86400)} ÙŠÙˆÙ…`:`${Math.floor(diff/86400)} days ago`);
            return currentLang==='fa'?'Ù‚Ø¯ÛŒÙ…ÛŒ':(currentLang==='ar'?'Ù‚Ø¯ÙŠÙ…':'old');
        }

        // ========== Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± ==========
        async function loadUserProfile() {
            const bHome = document.getElementById('walletBalance');
            const pHome = document.getElementById('userPoints');
            const bProf = document.getElementById('profileBalance');
            const pProf = document.getElementById('profilePoints');
            const ref = document.getElementById('referralLink');
            if (!userId) {
                bHome.innerText = pHome.innerText = '0';
                if(bProf) bProf.innerText = pProf.innerText = '0';
                ref.value = 'Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±Ø¯ ØªÙ„Ú¯Ø±Ø§Ù… Ø´ÙˆÛŒØ¯';
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/api/user/profile?user_id=${userId}`);
                if(!res.ok) throw new Error();
                const data = await res.json();
                if(data.success) {
                    const bal = Number(data.balance)||0, pts = Number(data.points)||0;
                    bHome.innerText = bal.toLocaleString();
                    pHome.innerText = pts;
                    if(bProf) bProf.innerText = bal.toLocaleString();
                    if(pProf) pProf.innerText = pts;
                    ref.value = data.referral_code ? `https://t.me/${BOT_USERNAME}?start=${data.referral_code}` : 'Ú©Ø¯ Ø¯Ø¹ÙˆØª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª';
                } else {
                    bHome.innerText = pHome.innerText = '0';
                    ref.value = 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯';
                }
            } catch {
                bHome.innerText = pHome.innerText = '0';
                ref.value = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·';
            }
        }

        // ========== Ø¯Ø±ÛŒØ§ÙØª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ ==========
        async function loadAds() {
            try {
                const res = await fetch(`${API_BASE}/api/ads`);
                const data = await res.json();
                if(data.success) {
                    allAds = data.ads.sort((a,b) => {
                        if (a.ad_type === 'special' && b.ad_type !== 'special') return -1;
                        if (a.ad_type !== 'special' && b.ad_type === 'special') return 1;
                        return b.created_at - a.created_at;
                    });
                } else allAds = [];
            } catch { allAds = []; }
            renderAds(allAds, 'adsGrid');
            renderAds(allAds.filter(ad => favorites.includes(ad.id)), 'favoritesGrid');
        }

        function getImgUrl(ids, index = 0) {
            try {
                let arr = Array.isArray(ids) ? ids : JSON.parse(ids);
                return arr.length > index ? `${API_BASE}/image/${arr[index]}` : 'https://via.placeholder.com/400?text=No+Image';
            } catch { return 'https://via.placeholder.com/400?text=No+Image'; }
        }

        function renderAds(ads, containerId) {
            const cont = document.getElementById(containerId);
            if (!cont) return;
            if (!ads.length) {
                cont.innerHTML = `<div style="text-align:center; padding:40px; color:#aaa;">${t('no_ads')}</div>`;
                return;
            }
            cont.innerHTML = ads.map(ad => {
                const img = getImgUrl(ad.image_ids);
                const isFav = favorites.includes(ad.id);
                const time = getRelativeTime(ad.created_at);
                const loc = ad.city || '';
                const meta = `${time} ${loc ? 'Ø¯Ø± ' + loc : ''}`;
                const specialBadge = ad.ad_type === 'special' ? `<span class="special-badge">${t('special_badge')}</span>` : '';
                const priceDisplay = formatPrice(ad.price);
                const specialClass = ad.ad_type === 'special' ? 'special-ad' : '';
                return `<div class="ad-card ${specialClass}" data-id="${ad.id}">
                    ${specialBadge}
                    <img class="ad-img" src="${img}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="ad-info">
                        <div class="ad-title">${ad.title}</div>
                        <div>
                            <div class="ad-price">${priceDisplay}</div>
                            <div class="ad-meta">${meta}</div>
                        </div>
                    </div>
                    <div class="favorite" onclick="toggleFavorite(event, ${ad.id})">${isFav ? 'â¤ï¸' : 'ğŸ¤'}</div>
                </div>`;
            }).join('');
            document.querySelectorAll(`#${containerId} .ad-card`).forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('favorite')) showAd(card.dataset.id);
                });
            });
        }

        window.toggleFavorite = (e, id) => {
            e.stopPropagation();
            let idx = favorites.indexOf(id);
            if (idx === -1) favorites.push(id); else favorites.splice(idx, 1);
            localStorage.setItem('jedar_favorites', JSON.stringify(favorites));
            renderAds(allAds, 'adsGrid');
            renderAds(allAds.filter(ad => favorites.includes(ad.id)), 'favoritesGrid');
        };

        // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØµÙˆØ± ==========
        let currentImages = [], currentIdx = 0;

        // ========== ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
        window.openGalleryFromMain = function() {
            if (!currentImages.length) return;
            currentIdx = 0;
            updateGallery();
            document.getElementById('galleryModal').classList.add('active');
        };

        function updateGallery() {
            document.getElementById('galleryImg').src = `${API_BASE}/image/${currentImages[currentIdx]}`;
            document.getElementById('galleryCounter').innerText = t('imageCounter').replace('{current}', currentIdx+1).replace('{total}', currentImages.length);
        }

        document.getElementById('galleryBack').addEventListener('click', () => document.getElementById('galleryModal').classList.remove('active'));
        document.getElementById('galleryPrev').addEventListener('click', () => {
            if (currentImages.length) { currentIdx = (currentIdx - 1 + currentImages.length) % currentImages.length; updateGallery(); }
        });
        document.getElementById('galleryNext').addEventListener('click', () => {
            if (currentImages.length) { currentIdx = (currentIdx + 1) % currentImages.length; updateGallery(); }
        });

        // ========== Ù†Ù…Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒ ==========
        window.showAd = async (id) => {
            const ad = allAds.find(a => a.id == id);
            if (!ad) return;
            const images = ad.image_ids ? (Array.isArray(ad.image_ids) ? ad.image_ids : JSON.parse(ad.image_ids)) : [];
            currentImages = images;
            const timeStr = getRelativeTime(ad.created_at);
            const locStr = ad.city || '';
            const locTime = `${timeStr} ${locStr ? 'Ø¯Ø± ' + locStr : ''}`;
            const phone = ad.phone || '';
            const countrySelect = document.getElementById('country');
            const countryCode = countrySelect ? countryCodes[countrySelect.value] || '98' : '98';
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            const formattedPhone = formatPhoneNumber(phone, countryCode);
            const whatsappLink = formattedPhone ? `https://wa.me/${formattedPhone}` : '#';
            
            const tgUsername = ad.telegram_username || '';
            // Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ØŒ ÙˆØ¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…ØŸ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ÙŠØ­ØªØ§Ø¬ Ù…Ø¹Ø±Ù ÙˆÙ„ÙŠØ³ Ø±Ù‚Ù… Ø¹Ø§Ø¯Ø©.
            // Ø³Ù†ÙƒØªÙÙŠ Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¹Ø¨Ø± Ø§Ù„Ù…Ø¹Ø±Ù Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø±Ù‚Ù… ÙˆÙ„ÙƒÙ† Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ø§ ÙŠØ¯Ø®Ù„ Ø¨Ø§Ù„Ø±Ù‚Ù… Ù…Ø¨Ø§Ø´Ø±Ø©.
            // Ø¨Ø¹Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ØªØ³Ù…Ø­ Ø¨ÙØªØ­ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø±Ù‚Ù… Ø¹Ø¨Ø± deep linkØŒ Ù„ÙƒÙ† Ù„ÙŠØ³ Ø´Ø§Ø¦Ø¹Ø§Ù‹.
            const tgLink = tgUsername ? `https://t.me/${tgUsername}` : (formattedPhone ? `https://t.me/+${formattedPhone}` : '#');
            
            const descHtml = ad.description || 'ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';

            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            document.getElementById('modalMainImage').src = getImgUrl(ad.image_ids, 0);
            // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯
            const moreBtn = document.getElementById('moreImagesText');
            if (images.length > 1) {
                moreBtn.innerText = t('more_images') + ' (' + images.length + ')';
                document.getElementById('moreImagesBtn').style.display = 'flex';
            } else {
                document.getElementById('moreImagesBtn').style.display = 'none';
            }

            // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            document.getElementById('modalTitle').innerText = ad.title;
            document.getElementById('modalMeta').innerText = locTime;
            document.getElementById('modalPrice').innerText = formatPrice(ad.price);
            document.getElementById('modalCat').innerText = ad.category || 'Ù…ØªÙØ±Ù‚Ù‡';
            document.getElementById('modalCity').innerText = ad.city || 'Ù†Ø§Ù…Ø´Ø®Øµ';
            document.getElementById('modalDesc').innerText = descHtml;
            document.getElementById('modalCallBtn').href = `tel:${phone}`;
            document.getElementById('modalWhatsappBtn').href = whatsappLink;
            
            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø²Ø± ØªÙ„Ø¬Ø±Ø§Ù…: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ø±Ù ÙŠØ³Ø§ÙˆÙŠ MY_TELEGRAM_ID Ù†Ø¹Ø·Ù„Ù‡
            const tgBtn = document.getElementById('modalTelegramBtn');
            if (tgUsername && tgUsername === MY_TELEGRAM_ID) {
                tgBtn.classList.add('btn-disabled');
                tgBtn.href = '#'; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·
                tgBtn.style.pointerEvents = 'none';
                tgBtn.style.opacity = '0.4';
            } else {
                tgBtn.classList.remove('btn-disabled');
                tgBtn.href = tgLink;
                tgBtn.style.pointerEvents = 'auto';
                tgBtn.style.opacity = '1';
            }

            // Ù†Ø¸Ø±Ø§Øª
            let reviewsHtml = '';
            let avgRating = ad.rating_avg ? ad.rating_avg.toFixed(1) : '0';
            let reviewCount = ad.rating_count || 0;
            try {
                const revRes = await fetch(`${API_BASE}/api/reviews?adId=${id}`);
                const revData = await revRes.json();
                const revs = revData.reviews || [];
                reviewCount = revs.length;
                if (revs.length) {
                    const sum = revs.reduce((a, r) => a + r.rating, 0);
                    avgRating = (sum / revs.length).toFixed(1);
                }
                reviewsHtml = revs.map(r => {
                    const stars = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(5 - r.rating);
                    return `<div class="review-item">
                        <div class="user"><i class="fas fa-user-circle"></i><span class="user-name">${r.first_name || r.username || 'Ú©Ø§Ø±Ø¨Ø±'}</span></div>
                        <div class="rating-stars">${stars}</div>
                        <div class="comment">${r.comment || 'Ø¨Ø¯ÙˆÙ† Ù†Ø¸Ø±'}</div>
                        <div class="date">${new Date(r.created_at*1000).toLocaleDateString()}</div>
                    </div>`;
                }).join('');
            } catch (e) { console.error('Ø®Ø·Ø§ Ø¯Ø± Ù†Ø¸Ø±Ø§Øª', e); }

            document.getElementById('reviewsContainer').innerHTML = `
                <div class="review-header">
                    <span class="avg"><i class="fas fa-star"></i> ${avgRating}</span>
                    <span class="stars">${'â˜…'.repeat(Math.round(parseFloat(avgRating)))}${'â˜†'.repeat(5 - Math.round(parseFloat(avgRating)))}</span>
                    <span class="count">(${reviewCount} ${t('reviewsCount')})</span>
                </div>
                ${reviewsHtml || '<p style="color:#aaa;">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                <div class="review-input">
                    <input type="number" id="newRating" min="1" max="5" placeholder="Ø§Ù…ØªÛŒØ§Ø² (1-5)">
                    <textarea id="newComment" placeholder="Ù†Ø¸Ø± Ø´Ù…Ø§..." rows="2"></textarea>
                    <button onclick="submitReview(${ad.id})"><i class="fas fa-paper-plane"></i> ${t('save')}</button>
                </div>
            `;

            document.getElementById('adModal').classList.add('active');
            if (tg) tg.BackButton.show();
            // Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø§Ø²Ø¯ÛŒØ¯
            fetch(`${API_BASE}/api/view`, { method: 'POST', body: JSON.stringify({ adId: ad.id }), headers: { 'Content-Type': 'application/json' } });
        };

        window.submitReview = async (adId) => {
            const rating = parseInt(document.getElementById('newRating').value);
            const comment = document.getElementById('newComment').value;
            if (!rating || rating < 1 || rating > 5) { alert('Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 ØªØ§ 5 Ø¨Ø§Ø´Ø¯'); return; }
            if (!userId) { alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯'); return; }
            const res = await fetch(`${API_BASE}/api/review`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adId, userId, rating, comment })
            });
            const data = await res.json();
            if (data.success) { alert('Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯'); closeModal(); loadAds(); }
            else alert('Ø®Ø·Ø§: ' + data.error);
        };

        function closeModal() {
            document.getElementById('adModal').classList.remove('active');
            if (tg) tg.BackButton.hide();
        }

        if (tg) tg.onEvent('backButtonClicked', closeModal);

        // ========== Ù†Ø§ÙˆØ¨Ø±ÛŒ ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                const page = item.dataset.page;
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(page + 'Page').classList.add('active');
                if (page === 'favorites') {
                    renderAds(allAds.filter(ad => favorites.includes(ad.id)), 'favoritesGrid');
                } else if (page === 'profile') {
                    loadUserProfile();
                }
                updateUILanguage();
            });
        });

        // ========== Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ Ø±Ø¨Ø§Øª ==========
        function redirectToBot(action) {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ù…Ø± ÙŠØ¨Ø¯Ø£ Ø¨Ù€ / Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            // Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙˆØªØ§Øª ØªØªÙˆÙ‚Ø¹ Ø§Ù„Ø£Ù…Ø± Ù…Ø¹ / ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            // ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø°Ù„Ùƒ Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙˆØª
            const url = `https://t.me/${BOT_USERNAME}?start=${action}`;
            if (tg) {
                tg.openTelegramLink(url);
            } else {
                window.open(url, '_blank');
            }
        }

        document.getElementById('postAdBtn').addEventListener('click', () => redirectToBot('post_ad'));
        document.getElementById('vipBtn').addEventListener('click', () => redirectToBot('vip'));
        document.getElementById('chargeBtn').addEventListener('click', () => redirectToBot('charge'));
        document.getElementById('convertPointsBtn').addEventListener('click', () => redirectToBot('convert_points'));

        document.getElementById('saveProfile').addEventListener('click', () => {
            const name = document.getElementById('displayName').value;
            const country = document.getElementById('country').value;
            if (tg) {
                tg.sendData(JSON.stringify({ action: 'updateProfile', displayName: name, country }));
                tg.showPopup({ title: 'âœ…', message: t('save') });
            } else {
                alert('Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¨Ø±ÙˆÛŒØ¯.');
                redirectToBot('updateProfile');
            }
        });

        document.getElementById('copyReferral').addEventListener('click', () => {
            const link = document.getElementById('referralLink');
            link.select();
            navigator.clipboard.writeText(link.value).then(() => {
                if (tg) tg.showPopup({ title: 'âœ…', message: t('copyHint') }); else alert(t('copyHint'));
            });
        });

        document.getElementById('shareReferral').addEventListener('click', () => {
            const link = document.getElementById('referralLink').value;
            if (navigator.share) {
                navigator.share({ title: 'Ø¯Ø¹ÙˆØª Ø¨Ù‡ Ø¬Ø¯Ø§Ø±', text: 'Ø¨Ù‡ Ø¬Ø¯Ø§Ø± Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯', url: link });
            } else {
                alert('Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª: ' + link);
            }
        });

        // ========== Ø¬Ø³ØªØ¬Ùˆ ==========
        document.getElementById('searchInput').addEventListener('keyup', filterAdsBySearch);
        function filterAdsBySearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allAds.filter(ad => {
                const matchMain = currentMainCat === 'all' ? true : ad.category?.includes(currentMainCat);
                const matchTerm = ad.title?.toLowerCase().includes(term) || ad.description?.toLowerCase().includes(term);
                return matchMain && matchTerm;
            });
            renderAds(filtered, 'adsGrid');
        }

        // ========== Ø°Ø±Ø§Øª Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ ==========
        (function initParticles() {
            const canvas = document.getElementById('particles');
            const ctx = canvas.getContext('2d');
            let w, h, particles = [];
            function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
            window.addEventListener('resize', resize); resize();
            for (let i = 0; i < 60; i++) {
                particles.push({
                    x: Math.random() * w, y: Math.random() * h,
                    vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2,
                    r: Math.random() * 2 + 1, col: `rgba(218,165,32,${Math.random() * 0.3 + 0.1})`
                });
            }
            function draw() {
                ctx.clearRect(0, 0, w, h);
                particles.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
                    ctx.fillStyle = p.col; ctx.fill();
                    p.x += p.vx; p.y += p.vy;
                    if (p.x < 0 || p.x > w) p.vx *= -1;
                    if (p.y < 0 || p.y > h) p.vy *= -1;
                });
                requestAnimationFrame(draw);
            }
            draw();
        })();

        // ========== Ø´Ø±ÙˆØ¹ ==========
        loadAds();
        renderCategories();
        updateUILanguage();
        loadUserProfile();

        // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
        document.getElementById('displayName').addEventListener('input', e => localStorage.setItem('jedar_displayName', e.target.value));
        document.getElementById('country').addEventListener('change', e => localStorage.setItem('jedar_country', e.target.value));
        const savedName = localStorage.getItem('jedar_displayName');
        if (savedName) document.getElementById('displayName').value = savedName;
        const savedCountry = localStorage.getItem('jedar_country');
        if (savedCountry) document.getElementById('country').value = savedCountry;
    </script>

<script>
/* ======== PRODUCTION PATCH - FINAL SAFE FIX ======== */

(function(){

const ADMIN_USERNAME = "Mehdi_E_admin";

function safeString(v){
    return typeof v === "string" ? v.trim() : "";
}

function formatPhoneNumberSafe(phone, countryCode){
    if(!phone) return null;
    let cleaned = phone.replace(/\D/g,'');
    if(cleaned.startsWith('0')) cleaned = cleaned.substring(1);
    if(countryCode && !cleaned.startsWith(countryCode)){
        cleaned = countryCode + cleaned;
    }
    return cleaned || null;
}

/* Override existing modal contact button logic safely */
window.applyContactSecurityPatch = function(ad){

    try{

        const tgBtn = document.querySelector('[data-contact="telegram"], .contact-telegram, #telegramBtn');
        const waBtn = document.querySelector('[data-contact="whatsapp"], .contact-whatsapp, #whatsappBtn');
        const callBtn = document.querySelector('[data-contact="call"], .contact-call, #callBtn');

        if(!ad || typeof ad !== "object"){
            [tgBtn,waBtn,callBtn].forEach(btn=>{
                if(btn){ btn.style.opacity="0.4"; btn.style.pointerEvents="none"; }
            });
            return;
        }

        /* Telegram Disable for Admin Ref */
        const username = safeString(ad.telegram_username);
        if(tgBtn){
            if(!username || username === ADMIN_USERNAME){
                tgBtn.style.opacity="0.4";
                tgBtn.style.pointerEvents="none";
                tgBtn.removeAttribute("href");
            }else{
                tgBtn.style.opacity="1";
                tgBtn.style.pointerEvents="auto";
                tgBtn.href = "https://t.me/" + username;
            }
        }

        /* WhatsApp Safe Format */
        if(waBtn){
            const formatted = formatPhoneNumberSafe(ad.phone, ad.country_code || "98");
            if(formatted){
                waBtn.href = "https://wa.me/" + formatted;
                waBtn.style.opacity="1";
                waBtn.style.pointerEvents="auto";
            }else{
                waBtn.style.opacity="0.4";
                waBtn.style.pointerEvents="none";
                waBtn.removeAttribute("href");
            }
        }

        /* Call Safe */
        if(callBtn){
            if(ad.phone){
                callBtn.href = "tel:" + ad.phone;
                callBtn.style.opacity="1";
                callBtn.style.pointerEvents="auto";
            }else{
                callBtn.style.opacity="0.4";
                callBtn.style.pointerEvents="none";
                callBtn.removeAttribute("href");
            }
        }

    }catch(e){
        console.error("Patch error:",e);
    }

};

})();
</script>

</body>
    </html>
