<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­ + Ø§ÛŒØ±Ø§Ù†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ØªÙ…Ø§Ù… Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª */
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        body { font-family: 'Tahoma', sans-serif; background: linear-gradient(45deg, #0f2027, #203a43, #2c5364); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: #fff; min-height: 100vh; direction: rtl; margin: 0; overflow-x: hidden; }
        .container { max-width: 500px; margin: 0 auto; padding: 16px; padding-bottom: 80px; position: relative; z-index: 10; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { font-size: 22px; font-weight: bold; }
        .logo span { color: #ffd700; }
        .lang-btn, .dots-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 44px; height: 44px; color: white; cursor: pointer; }
        .special-carousel { background: rgba(0,0,0,0.3); border-radius: 20px; padding: 16px; margin-bottom: 20px; overflow: hidden; }
        .carousel-track { display: flex; gap: 12px; animation: scroll 20s linear infinite; width: max-content; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .special-item { width: 140px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; text-align: center; }
        .special-item img { width: 100%; height: 80px; object-fit: cover; border-radius: 8px; }
        .ads-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .ad-card { background: rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; position: relative; }
        .ad-card img { width: 100%; height: 120px; object-fit: cover; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; background: rgba(0,0,0,0.8); display: flex; justify-content: space-around; padding: 10px; border-radius: 20px 20px 0 0; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal.active { display: block; }
        .category-chip { background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px; white-space: nowrap; cursor: pointer; margin-left: 5px; display: inline-block; }
        .category-chip.active { background: #ffd700; color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­ <span>+ Ø§ÛŒØ±Ø§Ù†</span></div>
            <div class="header-left">
                <button class="lang-btn" id="langMainBtn">ğŸŒ</button>
                <button class="dots-btn" id="dotsBtn">â‹¯</button>
            </div>
        </div>

        <div id="homePage" class="page active">
            <div class="special-carousel"><div class="carousel-track" id="specialTrack"></div></div>
            <div class="search-section">
                <div class="categories" id="categoryList" style="overflow-x: auto; display: flex; padding-bottom: 10px;"></div>
            </div>
            <div class="ads-grid" id="adsGrid"></div>
        </div>
    </div>

    <div class="modal" id="adModal"><div id="modalContent"></div></div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home')">ğŸ  Ø®Ø§Ù†Ù‡</div>
        <div class="nav-item" onclick="showPage('favorites')">â¤ï¸ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ</div>
        <div class="nav-item" onclick="showPage('profile')">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const API_BASE = 'https://souq-bot.mehdi11eidani.workers.dev';
        let allAds = [];

        // Ø§ØµÙ„Ø§Ø­ Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³
        function getImgUrl(imageIds) {
            try {
                if (!imageIds) return 'https://via.placeholder.com/150x120?text=No+Image';
                const ids = Array.isArray(imageIds) ? imageIds : JSON.parse(imageIds);
                return ids.length ? `${API_BASE}/image/${ids[0]}` : 'https://via.placeholder.com/150x120?text=No+Image';
            } catch (e) { return 'https://via.placeholder.com/150x120?text=No+Image'; }
        }

        async function loadAds() {
            try {
                const res = await fetch(`${API_BASE}/api/ads`);
                const data = await res.json();
                if (data.success) {
                    allAds = data.ads;
                    renderAds(allAds);
                    renderSpecial(allAds.filter(a => a.ad_type === 'special'));
                }
            } catch (e) { console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ú¯Ù‡ÛŒ", e); }
        }

        function renderAds(ads) {
            const grid = document.getElementById('adsGrid');
            grid.innerHTML = ads.map(ad => `
                <div class="ad-card" onclick="showAd(${ad.id})">
                    <img src="${getImgUrl(ad.image_ids)}" onerror="this.src='https://via.placeholder.com/150x120'">
                    <div style="padding:10px;">
                        <div style="font-weight:bold">${ad.title}</div>
                        <div style="color:gold">${ad.price} ${ad.currency}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderSpecial(ads) {
            const track = document.getElementById('specialTrack');
            track.innerHTML = ads.concat(ads).map(ad => `
                <div class="special-item" onclick="showAd(${ad.id})">
                    <img src="${getImgUrl(ad.image_ids)}">
                    <div style="font-size:12px">${ad.title}</div>
                </div>
            `).join('');
        }

        // Ø§ØµÙ„Ø§Ø­ Ø¯Ú©Ù…Ù‡ Ø²Ø¨Ø§Ù†
        document.getElementById('langMainBtn').onclick = () => {
            tg.showPopup({
                title: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†',
                message: 'Ø²Ø¨Ø§Ù† Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:',
                buttons: [
                    {id: 'fa', type: 'default', text: 'ÙØ§Ø±Ø³ÛŒ'},
                    {id: 'ar', type: 'default', text: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'},
                    {id: 'en', type: 'default', text: 'English'}
                ]
            }, (id) => { if(id) alert('Ø²Ø¨Ø§Ù† Ø¨Ù‡ ' + id + ' ØªØºÛŒÛŒØ± ÛŒØ§ÙØª'); });
        };

        window.showAd = (id) => {
            const ad = allAds.find(a => a.id == id);
            document.getElementById('modalContent').innerHTML = `
                <button onclick="document.getElementById('adModal').classList.remove('active')" style="color:#fff; background:none; border:none; font-size:20px;">âœ– Ø¨Ø³ØªÙ†</button>
                <img src="${getImgUrl(ad.image_ids)}" style="width:100%; border-radius:15px; margin-top:10px;">
                <h2>${ad.title}</h2>
                <p>${ad.description}</p>
                <button style="width:100%; padding:15px; background:gold; border:none; border-radius:10px; font-weight:bold;">ØªÙ…Ø§Ø³ Ø¨Ø§ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</button>
            `;
            document.getElementById('adModal').classList.add('active');
        };

        loadAds();
    </script>
</body>
</html>
