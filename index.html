<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­ | Ù†Ø³Ù„ Ø¢ÛŒÙ†Ø¯Ù‡</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
        }

        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.5);
            --gold: #fbbf24;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #f0f9ff, #e0f2fe, #bae6fd);
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.9);
            --text: #0f172a;
            --text-dim: #475569;
        }

        body {
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--text);
            min-height: 100vh;
            padding: 16px 16px 80px;
            transition: var(--transition);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ===== HEADER ===== */
        .glass-header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 900;
            background: linear-gradient(135deg, #fff, #a5f3fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .lang-selector {
            display: flex;
            gap: 8px;
        }

        .lang-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
        }

        .lang-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== PROFILE CARD ===== */
        .profile-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #a78bfa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .profile-info h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .profile-info p {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .profile-sub {
            margin-top: 4px;
            background: rgba(251, 191, 36, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            display: inline-block;
        }

        /* ===== SEARCH ===== */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 16px 50px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            color: var(--text);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        .search-box i {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-size: 1.2rem;
        }

        .search-icon { right: 20px; }
        .search-clear { left: 20px; cursor: pointer; display: none; }

        /* ===== CATEGORIES ===== */
        .categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 4px;
            scrollbar-width: none;
        }
        .categories::-webkit-scrollbar { display: none; }

        .cat-chip {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 8px 18px;
            white-space: nowrap;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .cat-chip.active {
            background: var(--primary);
            color: white;
        }

        /* ===== SPECIAL ADS CAROUSEL ===== */
        .special-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .special-carousel {
            overflow: hidden;
        }

        .carousel-track {
            display: flex;
            gap: 16px;
            animation: scroll 30s linear infinite;
            padding: 4px 0;
            will-change: transform;
        }

        .carousel-track:hover { animation-play-state: paused; }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(calc(-260px * 3)); }
        }

        .special-card {
            min-width: 240px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 20px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .special-card:hover {
            transform: scale(1.02) translateY(-2px);
            border-color: var(--gold);
        }

        .special-badge {
            background: var(--gold);
            color: #0f172a;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 8px;
        }

        /* ===== ADS GRID ===== */
        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .ad-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }

        .ad-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        .ad-image {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
            font-size: 2rem;
        }

        .ad-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-info {
            padding: 12px;
        }

        .ad-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .ad-price {
            font-weight: 700;
            color: var(--gold);
            font-size: 0.9rem;
        }

        .ad-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 8px;
        }

        .ad-translate {
            margin-top: 8px;
            display: flex;
            gap: 4px;
        }

        .ad-translate button {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 0.6rem;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .ad-translate button:hover {
            background: var(--primary);
        }

        /* ===== FLOATING ACTION BUTTON ===== */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: linear-gradient(135deg, var(--primary), #a78bfa);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 20px var(--primary-glow);
            cursor: pointer;
            z-index: 30;
            transition: var(--transition);
        }

        .fab:hover { transform: scale(1.1) rotate(90deg); }

        .fab-menu {
            position: fixed;
            bottom: 160px;
            right: 16px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 31;
            min-width: 180px;
        }

        .fab-menu.active { display: flex; }

        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            border-radius: 20px;
        }

        .fab-item:hover { background: var(--glass); }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 12px 20px;
            z-index: 20;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.7rem;
            transition: var(--transition);
        }

        .nav-item.active { color: var(--gold); transform: translateY(-3px); }
        .nav-item i { font-size: 1.3rem; }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover { background: var(--primary); color: white; }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .modal-body {
            line-height: 1.8;
        }

        .modal-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            padding: 12px 20px;
            border-radius: 40px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 700;
        }

        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }

        /* ===== TRANSLATE POPUP ===== */
        .lang-popup {
            position: fixed;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 20px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .lang-popup.active { display: flex; }

        .lang-option {
            padding: 12px;
            text-align: center;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
        }

        .lang-option:hover { background: var(--glass); }

        .loader {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }
    </style>
</head>
<body data-theme="dark">

    <!-- ===== HEADER WITH LANG SWITCHER ===== -->
    <div class="glass-header">
        <div class="logo">Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­</div>
        <div class="lang-selector">
            <span class="lang-btn active" data-lang="fa">FA</span>
            <span class="lang-btn" data-lang="ar">AR</span>
            <span class="lang-btn" data-lang="en">EN</span>
        </div>
    </div>

    <!-- ===== PROFILE CARD ===== -->
    <div class="profile-card" id="profileCard">
        <div class="profile-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="profile-info">
            <h3 id="profileName">Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†</h3>
            <p id="profileId">-</p>
            <span class="profile-sub" id="profileSub">Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ú©</span>
        </div>
    </div>

    <!-- ===== SEARCH ===== -->
    <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§...">
        <i class="fas fa-times search-clear" id="searchClear"></i>
    </div>

    <!-- ===== CATEGORIES ===== -->
    <div class="categories" id="categories">
        <div class="cat-chip active" data-cat="all">Ù‡Ù…Ù‡</div>
        <div class="cat-chip" data-cat="Ø®ÙˆØ¯Ø±Ùˆ">Ø®ÙˆØ¯Ø±Ùˆ</div>
        <div class="cat-chip" data-cat="Ø§Ù…Ù„Ø§Ú©">Ø§Ù…Ù„Ø§Ú©</div>
        <div class="cat-chip" data-cat="Ù…ÙˆØ¨Ø§ÛŒÙ„">Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
        <div class="cat-chip" data-cat="Ù„Ù¾â€ŒØªØ§Ù¾">Ù„Ù¾â€ŒØªØ§Ù¾</div>
        <div class="cat-chip" data-cat="Ø®Ø¯Ù…Ø§Øª">Ø®Ø¯Ù…Ø§Øª</div>
        <div class="cat-chip" data-cat="Ø³Ø§ÛŒØ±">Ø³Ø§ÛŒØ±</div>
    </div>

    <!-- ===== SPECIAL ADS CAROUSEL ===== -->
    <div class="special-section">
        <div class="section-title">
            <i class="fas fa-crown" style="color: var(--gold);"></i>
            <span data-i18n="special">Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡</span>
        </div>
        <div class="special-carousel">
            <div class="carousel-track" id="specialTrack"></div>
        </div>
    </div>

    <!-- ===== ADS GRID ===== -->
    <div id="adsContainer" class="ads-grid"></div>

    <!-- ===== FLOATING ACTION BUTTON ===== -->
    <div class="fab" id="fab">
        <i class="fas fa-robot"></i>
    </div>
    <div class="fab-menu" id="fabMenu">
        <div class="fab-item" data-action="about"><i class="fas fa-info-circle"></i> Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</div>
        <div class="fab-item" data-action="contact"><i class="fas fa-envelope"></i> Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ù†</div>
        <div class="fab-item" data-action="goals"><i class="fas fa-bullseye"></i> Ø§Ù‡Ø¯Ø§Ù Ù¾Ø±ÙˆÚ˜Ù‡</div>
        <div class="fab-item" data-action="features"><i class="fas fa-star"></i> ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</div>
        <div class="fab-item" data-action="support"><i class="fas fa-headset"></i> Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</div>
        <div class="fab-item" data-action="translate"><i class="fas fa-language"></i> ØªØ±Ø¬Ù…Ù‡</div>
        <div class="fab-item" data-action="currency"><i class="fas fa-coins"></i> ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø²</div>
    </div>

    <!-- ===== BOTTOM NAVIGATION ===== -->
    <div class="bottom-nav">
        <div class="nav-item active" data-nav="home"><i class="fas fa-home"></i><span data-i18n="home">Ø®Ø§Ù†Ù‡</span></div>
        <div class="nav-item" data-nav="add"><i class="fas fa-plus-circle"></i><span data-i18n="add">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</span></div>
        <div class="nav-item" data-nav="vip"><i class="fas fa-crown"></i><span data-i18n="vip">Ø§Ø´ØªØ±Ø§Ú©</span></div>
        <div class="nav-item" data-nav="profile"><i class="fas fa-user"></i><span data-i18n="profile">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span></div>
    </div>

    <!-- ===== MODAL FOR PAGES ===== -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-close" onclick="closeModal()"><i class="fas fa-arrow-right"></i></div>
                <span class="modal-title" id="modalTitle"></span>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- ===== LANGUAGE POPUP FOR TRANSLATION ===== -->
    <div id="translatePopup" class="lang-popup">
        <div class="lang-option" data-lang="fa">ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ</div>
        <div class="lang-option" data-lang="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
        <div class="lang-option" data-lang="en">ğŸ‡¬ğŸ‡§ English</div>
    </div>

    <!-- ===== CURRENCY POPUP ===== -->
    <div id="currencyPopup" class="lang-popup">
        <div class="lang-option" data-currency="USD">ğŸ’µ Ø¯Ù„Ø§Ø± (USD)</div>
        <div class="lang-option" data-currency="EUR">ğŸ’¶ ÛŒÙˆØ±Ùˆ (EUR)</div>
        <div class="lang-option" data-currency="GBP">ğŸ’· Ù¾ÙˆÙ†Ø¯ (GBP)</div>
        <div class="lang-option" data-currency="TRY">ğŸ’´ Ù„ÛŒØ± (TRY)</div>
    </div>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();

        // ===== CONSTANTS =====
        const API_BASE = 'https://souq-bot.mehdi11eidani.workers.dev';
        const BOT_TOKEN = '8587925383:AAElQXNbZ8YIDJMWwX4YyVFMCOsC2pV6H6c';
        const BOT_USERNAME = 'AlsouqAlmaftuhiran_bot';
        const SUPPORT_USERNAME = 'Mehdi_E_admin';

        // ===== TRANSLATIONS =====
        const i18n = {
            fa: {
                special: 'Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡',
                home: 'Ø®Ø§Ù†Ù‡',
                add: 'Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ',
                vip: 'Ø§Ø´ØªØ±Ø§Ú©',
                profile: 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„',
                about: 'Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§',
                contact: 'Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ù†',
                goals: 'Ø§Ù‡Ø¯Ø§Ù Ù¾Ø±ÙˆÚ˜Ù‡',
                features: 'ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§',
                support: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ',
                no_sub: 'Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ú©',
                search: 'Ø¬Ø³ØªØ¬Ùˆ...',
                ad_saved: 'Ø¢Ú¯Ù‡ÛŒ Ø«Ø¨Øª Ø´Ø¯',
                pending: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯'
            },
            ar: {
                special: 'Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙŠØ²Ø©',
                home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                add: 'Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯',
                vip: 'Ø§Ø´ØªØ±Ø§Ùƒ',
                profile: 'Ø§Ù„Ù…Ù„Ù',
                about: 'Ù…Ù† Ù†Ø­Ù†',
                contact: 'Ø§ØªØµÙ„ Ø¨ÙŠ',
                goals: 'Ø§Ù„Ø£Ù‡Ø¯Ø§Ù',
                features: 'Ø§Ù„Ù…ÙŠØ²Ø§Øª',
                support: 'Ø§Ù„Ø¯Ø¹Ù…',
                no_sub: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ',
                search: 'Ø¨Ø­Ø«...',
                ad_saved: 'ØªÙ… Ø§Ù„Ù†Ø´Ø±',
                pending: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'
            },
            en: {
                special: 'Special Ads',
                home: 'Home',
                add: 'Post Ad',
                vip: 'Subscribe',
                profile: 'Profile',
                about: 'About Us',
                contact: 'Contact Me',
                goals: 'Project Goals',
                features: 'Features',
                support: 'Support',
                no_sub: 'No Subscription',
                search: 'Search...',
                ad_saved: 'Ad saved',
                pending: 'Pending'
            }
        };

        let currentLang = 'fa';
        let currentAdForTranslation = null;
        let allAds = [];
        let currentFilter = 'all';
        let currentSearch = '';

        // ===== TELEGRAM USER INFO =====
        const user = tg.initDataUnsafe?.user;
        if (user) {
            document.getElementById('profileName').innerText = user.first_name || 'Ú©Ø§Ø±Ø¨Ø±';
            document.getElementById('profileId').innerText = `@${user.username || 'user'}`;
        }

        // ===== FETCH ADS =====
        async function fetchAds() {
            try {
                const res = await fetch(`${API_BASE}/api/ads`);
                const data = await res.json();
                if (data.success) {
                    allAds = data.ads || [];
                } else {
                    allAds = [];
                }
            } catch (e) {
                console.error(e);
                allAds = [];
            }
            renderSpecialCarousel();
            renderAds();
        }

        // ===== RENDER SPECIAL CAROUSEL =====
        function renderSpecialCarousel() {
            const specialAds = allAds.filter(ad => ad.ad_type === 'special');
            const track = document.getElementById('specialTrack');
            if (specialAds.length === 0) {
                track.innerHTML = '<div style="min-width:200px;">Ø¢Ú¯Ù‡ÛŒ ÙˆÛŒÚ˜Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                return;
            }
            // Duplicate to create infinite scroll effect
            const displayAds = [...specialAds, ...specialAds, ...specialAds];
            track.innerHTML = displayAds.map(ad => `
                <div class="special-card" onclick='showAdDetail(${JSON.stringify(ad).replace(/'/g, "&apos;")})'>
                    <span class="special-badge">âœ¨ ÙˆÛŒÚ˜Ù‡ ${ad.plan_days || 1} Ø±ÙˆØ²Ù‡</span>
                    <h3 style="margin-bottom:4px;">${ad.title}</h3>
                    <div style="font-weight:700; color:var(--gold);">${ad.price}</div>
                    <div style="font-size:0.7rem; margin-top:8px;">${ad.city || ''}</div>
                </div>
            `).join('');
        }

        // ===== RENDER ADS GRID =====
        function renderAds() {
            let filtered = allAds.filter(ad => ad.status === 'approved');
            if (currentFilter !== 'all') {
                filtered = filtered.filter(ad => ad.category === currentFilter);
            }
            if (currentSearch) {
                filtered = filtered.filter(ad => 
                    ad.title.includes(currentSearch) || 
                    ad.description?.includes(currentSearch)
                );
            }
            const container = document.getElementById('adsContainer');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loader">Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }
            container.innerHTML = filtered.map(ad => `
                <div class="ad-card" onclick='showAdDetail(${JSON.stringify(ad).replace(/'/g, "&apos;")})'>
                    <div class="ad-image">
                        ${getImageTag(ad)}
                    </div>
                    <div class="ad-info">
                        <div class="ad-title">${ad.title}</div>
                        <div class="ad-price">${ad.price}</div>
                        <div class="ad-meta">
                            <span>${ad.city || ''}</span>
                            <span>${new Date(ad.created_at * 1000).toLocaleDateString('fa-IR')}</span>
                        </div>
                        <div class="ad-translate">
                            <button onclick="event.stopPropagation(); showTranslatePopup(${ad.id})">ØªØ±Ø¬Ù…Ù‡</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ===== IMAGE TAG HELPER =====
        function getImageTag(ad) {
            try {
                const images = JSON.parse(ad.image_ids || '[]');
                if (images.length > 0) {
                    const url = `https://api.telegram.org/file/bot${BOT_TOKEN}/${images[0]}`;
                    return `<img src="${url}" onerror="this.style.display='none';this.parentElement.innerHTML='<i class=\\'fas fa-image\\'></i>';">`;
                }
            } catch (e) {}
            return '<i class="fas fa-image"></i>';
        }

        // ===== SHOW AD DETAIL =====
        function showAdDetail(ad) {
            const modal = document.getElementById('infoModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            title.innerText = ad.title;
            const imageHtml = getImageTag(ad).replace('<img', '<img style="width:100%; height:200px; object-fit:cover; border-radius:20px; margin-bottom:16px;"');
            body.innerHTML = `
                ${imageHtml}
                <div style="color:var(--gold); font-size:1.5rem; margin:12px 0;">${ad.price}</div>
                <p style="margin:12px 0;">${ad.description || ''}</p>
                <div style="background:var(--glass); padding:16px; border-radius:20px;">
                    <p><i class="fas fa-map-marker-alt"></i> ${ad.city || ''}ØŒ ${ad.country || ''}</p>
                    <p><i class="fas fa-calendar"></i> ${new Date(ad.created_at * 1000).toLocaleDateString('fa-IR')}</p>
                    ${ad.phone ? `<p><i class="fas fa-phone"></i> ${ad.phone}</p>` : ''}
                </div>
                <div style="display:flex; gap:8px; margin-top:20px;">
                    <button class="modal-btn" style="flex:1;" onclick="contactSeller('${ad.user_id}')">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</button>
                    <button class="modal-btn primary" style="flex:1;" onclick="shareAd(${ad.id})">Ø§Ø´ØªØ±Ø§Ú©</button>
                </div>
            `;
            modal.style.display = 'flex';
            tg.BackButton.show();
        }

        function contactSeller(userId) {
            tg.openTelegramLink(`https://t.me/${userId}`);
        }

        function shareAd(adId) {
            const ad = allAds.find(a => a.id == adId);
            if (ad) {
                const text = `${ad.title}\n${ad.price}`;
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(text)}`);
            }
        }

        // ===== TRANSLATE POPUP =====
        function showTranslatePopup(adId) {
            currentAdForTranslation = adId;
            document.getElementById('translatePopup').classList.add('active');
        }

        document.querySelectorAll('#translatePopup .lang-option').forEach(btn => {
            btn.addEventListener('click', async () => {
                const targetLang = btn.dataset.lang;
                const ad = allAds.find(a => a.id == currentAdForTranslation);
                if (ad) {
                    // Simulate translation (use MyMemory API or just mock)
                    const text = `${ad.title}\n${ad.description || ''}`;
                    // For demo, we'll just show a mock translation
                    let translated = '';
                    if (targetLang === 'en') translated = 'Translated to English: ' + text;
                    else if (targetLang === 'ar') translated = 'Translated to Arabic: ' + text;
                    else translated = text;
                    tg.showPopup({ message: translated });
                }
                document.getElementById('translatePopup').classList.remove('active');
            });
        });

        // ===== CURRENCY CONVERSION =====
        document.querySelectorAll('#currencyPopup .lang-option').forEach(btn => {
            btn.addEventListener('click', () => {
                const currency = btn.dataset.currency;
                // Mock conversion rates
                const rates = { USD: 60000, EUR: 65000, GBP: 75000, TRY: 2000 };
                const rate = rates[currency] || 60000;
                // Convert visible prices (simple demo)
                tg.showPopup({ message: `Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„: 1 ${currency} = ${rate} ØªÙˆÙ…Ø§Ù†` });
                document.getElementById('currencyPopup').classList.remove('active');
            });
        });

        // ===== FLOATING ACTION BUTTON =====
        const fab = document.getElementById('fab');
        const fabMenu = document.getElementById('fabMenu');
        fab.addEventListener('click', () => {
            fabMenu.classList.toggle('active');
        });

        document.querySelectorAll('.fab-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = e.currentTarget.dataset.action;
                fabMenu.classList.remove('active');
                if (action === 'about') {
                    openInfoModal('Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§', 'Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­ Ù¾Ù„ØªÙØ±Ù… Ø®Ø±ÛŒØ¯ Ùˆ ÙØ±ÙˆØ´ Ù…Ø·Ù…Ø¦Ù† Ø¯Ø± Ø§ÛŒØ±Ø§Ù† Ùˆ Ú©Ø´ÙˆØ±Ù‡Ø§ÛŒ Ø¹Ø±Ø¨ÛŒ Ø§Ø³Øª.');
                } else if (action === 'contact') {
                    tg.openTelegramLink(`https://t.me/${SUPPORT_USERNAME}`);
                } else if (action === 'goals') {
                    openInfoModal('Ø§Ù‡Ø¯Ø§Ù Ù¾Ø±ÙˆÚ˜Ù‡', 'Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒ Ø§Ù…Ù†ØŒ Ø§ØªØµØ§Ù„ Ø§ÛŒØ±Ø§Ù† Ùˆ Ú©Ø´ÙˆØ±Ù‡Ø§ÛŒ Ø¹Ø±Ø¨ÛŒØŒ Ø­Ø°Ù ÙˆØ§Ø³Ø·Ù‡â€ŒÙ‡Ø§.');
                } else if (action === 'features') {
                    openInfoModal('ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§', 'Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†ØŒ ÙˆÛŒÚ˜Ù‡ØŒ Ø§Ø´ØªØ±Ø§Ú©ØŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Û²Û´ Ø³Ø§Ø¹ØªÙ‡.');
                } else if (action === 'support') {
                    tg.openTelegramLink(`https://t.me/${SUPPORT_USERNAME}`);
                } else if (action === 'translate') {
                    // Open translation popup (needs ad context)
                    tg.showPopup({ message: 'Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¢Ú¯Ù‡ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯' });
                } else if (action === 'currency') {
                    document.getElementById('currencyPopup').classList.toggle('active');
                }
            });
        });

        function openInfoModal(title, body) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = `<p>${body}</p>`;
            document.getElementById('infoModal').style.display = 'flex';
        }

        // ===== CLOSE MODAL =====
        function closeModal() {
            document.getElementById('infoModal').style.display = 'none';
            tg.BackButton.hide();
        }

        // ===== LANGUAGE SWITCH =====
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const lang = btn.dataset.lang;
                currentLang = lang;
                document.documentElement.dir = lang === 'en' ? 'ltr' : 'rtl';
                // Update UI texts
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.dataset.i18n;
                    if (i18n[lang][key]) el.innerText = i18n[lang][key];
                });
                // Update placeholder
                document.getElementById('searchInput').placeholder = i18n[lang].search;
            });
        });

        // ===== SEARCH & FILTER =====
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentSearch = e.target.value;
            document.getElementById('searchClear').style.display = currentSearch ? 'block' : 'none';
            renderAds();
        });

        document.getElementById('searchClear').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            document.getElementById('searchClear').style.display = 'none';
            renderAds();
        });

        document.querySelectorAll('.cat-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.cat;
                renderAds();
            });
        });

        // ===== BOTTOM NAVIGATION =====
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                const nav = item.dataset.nav;
                if (nav === 'home') {
                    // already home
                } else if (nav === 'add') {
                    tg.openTelegramLink(`https://t.me/${BOT_USERNAME}?start=post_ad`);
                } else if (nav === 'vip') {
                    tg.openTelegramLink(`https://t.me/${BOT_USERNAME}?start=vip`);
                } else if (nav === 'profile') {
                    // show profile modal
                    openInfoModal('Ù¾Ø±ÙˆÙØ§ÛŒÙ„', `Ù†Ø§Ù…: ${user?.first_name || 'Ú©Ø§Ø±Ø¨Ø±'}\nØ¢ÛŒØ¯ÛŒ: @${user?.username || 'none'}\nØ§Ø´ØªØ±Ø§Ú©: ${i18n[currentLang].no_sub}`);
                }
            });
        });

        // ===== INIT =====
        fetchAds();
        tg.BackButton.onClick(closeModal);

        // Click outside to close fab menu
        document.addEventListener('click', (e) => {
            if (!fab.contains(e.target) && !fabMenu.contains(e.target)) {
                fabMenu.classList.remove('active');
            }
        });
    </script>
</body>
                </html>
